# 实现计划

## 任务列表

- [x] 1. 在 ISchedulingService 中新增确认并清空方法
  - 在 `Services/Interfaces/ISchedulingService.cs` 中添加 `ConfirmScheduleAndClearOthersAsync` 方法签名
  - 方法应接受草稿 ID 和可选的 clearOtherDrafts 参数
  - _需求: 4.1, 4.2_

- [x] 2. 在 SchedulingService 中实现确认并清空方法
  - [x] 2.1 实现 `ConfirmScheduleAndClearOthersAsync` 方法
    - 首先调用现有的 `ConfirmScheduleAsync` 方法确认指定草稿
    - 如果 clearOtherDrafts 为 true，获取所有剩余草稿
    - 遍历剩余草稿，逐个调用 `DeleteDraftAsync` 删除
    - 捕获删除失败的异常，记录日志但继续删除其他草稿
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 2.2 编写属性测试：确认后清空不变性
    - **属性 3: 确认后清空不变性**
    - **验证: 需求 4.3, 4.4**

  - [ ]* 2.3 编写属性测试：确认操作原子性
    - **属性 4: 确认操作原子性**
    - **验证: 需求 3.5, 4.5**

- [x] 3. 修改 DraftsViewModel 的确认命令
  - [x] 3.1 更新 `ConfirmDraftAsync` 方法
    - 修改确认对话框文本，添加"确认后将清空其他草稿"的警告信息
    - 调用新的 `ConfirmScheduleAndClearOthersAsync` 方法替代 `ConfirmScheduleAsync`
    - 确认成功后显示成功提示
    - 刷新草稿列表
    - _需求: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4_

  - [ ]* 3.2 编写单元测试：确认草稿并清空其他草稿
    - 测试确认草稿成功
    - 测试确认后其他草稿被删除
    - 测试确认失败时不删除其他草稿
    - 测试删除其他草稿部分失败的情况
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 4. 更新 DraftsPage 的确认对话框
  - [x] 4.1 修改确认对话框文本
    - 在 `DraftsViewModel.ConfirmDraftAsync` 中更新对话框文本
    - 添加警告图标和重要提示
    - 确保文本清楚说明确认后会清空其他草稿
    - _需求: 3.1, 4.1_

  - [ ]* 4.2 编写 UI 测试：确认对话框展示
    - 测试对话框文本包含警告信息
    - 测试对话框按钮功能正确
    - _需求: 3.1, 6.1, 6.2_

- [x] 5. 优化草稿列表的空状态展示
  - [x] 5.1 更新 DraftsPage.xaml 的空状态 UI
    - 确保空状态提示友好且清晰
    - 添加图标和说明文本
    - _需求: 1.3_

  - [ ]* 5.2 编写 UI 测试：空状态展示
    - 测试空状态正确显示
    - 测试空状态文本和图标
    - _需求: 1.3_

- [x] 6. 添加错误处理和日志记录
  - [x] 6.1 在 SchedulingService 中添加详细日志
    - 记录确认草稿操作
    - 记录删除其他草稿操作
    - 记录删除失败的错误
    - _需求: 4.5_

  - [x] 6.2 在 DraftsViewModel 中添加错误处理
    - 捕获确认失败的异常
    - 显示友好的错误提示
    - 确保 UI 状态正确恢复
    - _需求: 3.5, 4.5_

  - [ ]* 6.3 编写单元测试：错误处理
    - 测试确认失败的错误处理
    - 测试删除失败的错误处理
    - 测试 UI 状态恢复
    - _需求: 3.5, 4.5_

- [x] 7. 验证现有功能不受影响 ✅
  - [x] 7.1 测试查看草稿功能 ✅
    - 验证点击"查看"按钮正确导航
    - 验证传递的草稿 ID 正确
    - _需求: 2.1, 2.2, 2.3, 2.4_
    - _验证报告: TASK7_VERIFICATION_REPORT.md_

  - [x] 7.2 测试删除草稿功能 ✅
    - 验证点击"删除"按钮显示确认对话框
    - 验证删除成功后刷新列表
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_
    - _验证报告: TASK7_VERIFICATION_REPORT.md_

  - [x] 7.3 测试加载草稿列表功能 ✅
    - 验证页面导航时自动加载草稿列表
    - 验证加载指示器正确显示
    - 验证草稿信息正确展示
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_
    - _验证报告: TASK7_VERIFICATION_REPORT.md_

  - [ ]* 7.4 编写属性测试：草稿列表一致性
    - **属性 1: 草稿列表一致性**
    - **验证: 需求 1.5**

  - [ ]* 7.5 编写属性测试：导航参数正确性
    - **属性 2: 导航参数正确性**
    - **验证: 需求 2.2**

  - [ ]* 7.6 编写属性测试：删除操作幂等性
    - **属性 5: 删除操作幂等性**
    - **验证: 需求 5.5**

- [x] 8. 最终检查点 - 确保所有测试通过 ✅
  - 所有核心功能已实现并验证
  - 草稿箱功能完善已完成
  - _验证内容_:
    - ✅ 草稿列表正确加载和展示
    - ✅ 查看草稿功能正常工作
    - ✅ 确认草稿并清空其他草稿功能已实现
    - ✅ 删除单个草稿功能正常工作
    - ✅ 空状态展示友好清晰
    - ✅ 错误处理和日志记录完善
    - ✅ 确认对话框包含清晰的警告信息
