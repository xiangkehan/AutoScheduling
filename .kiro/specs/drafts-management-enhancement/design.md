# 设计文档

## 概述

本设计文档描述了草稿箱功能完善的技术实现方案。该功能将增强现有的 DraftsPage 和 DraftsViewModel，使其能够正确展示和管理已完成但未确认的排班结果，并在确认应用某个草稿后自动清空其他草稿。

## 架构

### 系统架构

```
┌─────────────────┐
│  DraftsPage     │ (View)
│  (XAML)         │
└────────┬────────┘
         │
         │ DataContext
         ▼
┌─────────────────┐
│ DraftsViewModel │ (ViewModel)
└────────┬────────┘
         │
         │ 依赖注入
         ▼
┌─────────────────┐      ┌──────────────────┐
│ ISchedulingService│────▶│ IHistoryManagement│
└─────────────────┘      └──────────────────┘
         │
         │
         ▼
┌─────────────────┐
│ NavigationService│
│ DialogService   │
└─────────────────┘
```

### 数据流

1. **加载草稿列表**：
   - DraftsPage.OnNavigatedTo → DraftsViewModel.LoadDraftsCommand
   - DraftsViewModel → ISchedulingService.GetDraftsAsync
   - ISchedulingService → IHistoryManagement.GetAllBufferSchedulesAsync
   - 返回 List<ScheduleSummaryDto> → DraftsViewModel.Drafts

2. **查看草稿详情**：
   - 用户点击"查看"按钮 → DraftsViewModel.ViewDraftCommand
   - DraftsViewModel → NavigationService.NavigateTo("ScheduleResult", scheduleId)
   - ScheduleResultPage 加载 → ScheduleResultViewModel.LoadScheduleAsync
   - ScheduleResultViewModel → ISchedulingService.GetScheduleByIdAsync

3. **确认草稿**：
   - 用户点击"确认"按钮 → DraftsViewModel.ConfirmDraftCommand
   - 显示确认对话框 → 用户确认
   - DraftsViewModel → ISchedulingService.ConfirmScheduleAsync
   - ISchedulingService → IHistoryManagement.ConfirmBufferScheduleAsync
   - ISchedulingService → 删除其他草稿
   - DraftsViewModel → 刷新草稿列表

4. **删除草稿**：
   - 用户点击"删除"按钮 → DraftsViewModel.DeleteDraftCommand
   - 显示确认对话框 → 用户确认
   - DraftsViewModel → ISchedulingService.DeleteDraftAsync
   - ISchedulingService → IHistoryManagement.DeleteBufferScheduleAsync
   - DraftsViewModel → 刷新草稿列表

## 组件和接口

### 1. DraftsViewModel（现有组件，需要修改）

**位置**: `ViewModels/Scheduling/DraftsViewModel.cs`

**职责**:
- 管理草稿列表的加载和展示
- 处理用户操作（查看、确认、删除）
- 与服务层交互

**属性**:
```csharp
public ObservableCollection<ScheduleSummaryDto> Drafts { get; set; }
public bool IsLoading { get; set; }
```

**命令**:
```csharp
public IAsyncRelayCommand LoadDraftsCommand { get; }
public IAsyncRelayCommand<int> ViewDraftCommand { get; }
public IAsyncRelayCommand<int> ConfirmDraftCommand { get; }
public IAsyncRelayCommand<int> DeleteDraftCommand { get; }
```

**修改点**:
- 修改 `ConfirmDraftAsync` 方法，在确认草稿后删除其他所有草稿

### 2. ISchedulingService（现有接口，需要新增方法）

**位置**: `Services/Interfaces/ISchedulingService.cs`

**新增方法**:
```csharp
/// <summary>
/// 确认草稿并清空其他草稿
/// </summary>
/// <param name="id">要确认的草稿ID</param>
/// <param name="clearOtherDrafts">是否清空其他草稿，默认为true</param>
Task ConfirmScheduleAndClearOthersAsync(int id, bool clearOtherDrafts = true);
```

### 3. SchedulingService（现有实现，需要新增方法）

**位置**: `Services/SchedulingService.cs`

**新增方法实现**:
```csharp
public async Task ConfirmScheduleAndClearOthersAsync(int id, bool clearOtherDrafts = true)
{
    // 1. 确认指定的草稿
    await ConfirmScheduleAsync(id);
    
    // 2. 如果需要清空其他草稿
    if (clearOtherDrafts)
    {
        // 获取所有剩余草稿
        var remainingDrafts = await GetDraftsAsync();
        
        // 删除所有剩余草稿
        foreach (var draft in remainingDrafts)
        {
            try
            {
                await DeleteDraftAsync(draft.Id);
            }
            catch (Exception ex)
            {
                // 记录错误但继续删除其他草稿
                System.Diagnostics.Debug.WriteLine($"删除草稿 {draft.Id} 失败: {ex.Message}");
            }
        }
    }
}
```

### 4. DraftsPage（现有视图，可能需要微调）

**位置**: `Views/Scheduling/DraftsPage.xaml`

**UI 元素**:
- ListView：展示草稿列表
- ProgressRing：加载指示器
- 每个草稿项包含：
  - 标题和创建时间
  - 日期范围
  - 人员数和哨位数
  - 操作按钮（查看、确认、删除）

**可能的修改**:
- 确保"确认"按钮的提示文本清楚说明会清空其他草稿
- 优化空状态展示

**UI 草稿（ASCII）**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  草稿箱                                                                      │
│  查看、确认或删除未完成的排班草稿                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ 排班表名称          │ 日期范围      │ 人员数 │ 哨位数 │ 操作           │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ 2024年1月排班       │ 2024-01-01   │   15   │   8    │ [查看] [确认]  │ │
│  │ 创建于: 2024-01-01  │ 至           │        │        │ [🗑️删除]       │ │
│  │ 10:30              │ 2024-01-31   │        │        │                │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ 2024年2月排班       │ 2024-02-01   │   18   │   10   │ [查看] [确认]  │ │
│  │ 创建于: 2024-01-15  │ 至           │        │        │ [🗑️删除]       │ │
│  │ 14:20              │ 2024-02-29   │        │        │                │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ 春节特殊排班        │ 2024-02-10   │   20   │   12   │ [查看] [确认]  │ │
│  │ 创建于: 2024-01-20  │ 至           │        │        │ [🗑️删除]       │ │
│  │ 09:15              │ 2024-02-17   │        │        │                │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

【加载状态】
┌─────────────────────────────────────────────────────────────────────────────┐
│  草稿箱                                                                      │
│  查看、确认或删除未完成的排班草稿                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                                                                              │
│                              ⏳ 正在加载...                                  │
│                                                                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

【空状态】
┌─────────────────────────────────────────────────────────────────────────────┐
│  草稿箱                                                                      │
│  查看、确认或删除未完成的排班草稿                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                              📋                                              │
│                         暂无草稿排班                                         │
│                   所有排班都已确认或删除                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

【确认对话框】
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⚠️  确认排班                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  确认后，该排班将保存到历史记录，无法再修改。                                │
│                                                                              │
│  ⚠️ 重要提示：确认此排班后，草稿箱中的所有其他草稿将被自动清空，            │
│  以避免重复应用排班。                                                        │
│                                                                              │
│  是否继续？                                                                  │
│                                                                              │
│                                    [确认]  [取消]                            │
└─────────────────────────────────────────────────────────────────────────────┘

【删除对话框】
┌─────────────────────────────────────────────────────────────────────────────┐
│  ⚠️  删除草稿                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  确认要删除这个排班草稿吗？此操作不可恢复。                                  │
│                                                                              │
│                                    [删除]  [取消]                            │
└─────────────────────────────────────────────────────────────────────────────┘

【操作成功提示】
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ 排班已确认                                                               │
│  草稿箱已清空                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

**UI 交互流程**:

1. **查看草稿详情**:
   ```
   用户点击 [查看] → 导航到 ScheduleResultPage → 展示完整排班详情
   ```

2. **确认草稿**:
   ```
   用户点击 [确认] → 显示确认对话框（含警告信息）
                   ↓
   用户点击 [确认] → 确认草稿 → 删除其他草稿 → 显示成功提示 → 刷新列表（空状态）
                   ↓
   用户点击 [取消] → 关闭对话框，不执行任何操作
   ```

3. **删除草稿**:
   ```
   用户点击 [🗑️删除] → 显示删除对话框
                     ↓
   用户点击 [删除] → 删除草稿 → 显示成功提示 → 刷新列表
                     ↓
   用户点击 [取消] → 关闭对话框，不执行任何操作
   ```

**按钮样式说明**:
- `[查看]`: 普通按钮（Button）
- `[确认]`: 强调按钮（AccentButtonStyle），使用主题色突出显示
- `[🗑️删除]`: 图标按钮（AppBarButton），使用删除图标

## 数据模型

### ScheduleSummaryDto（现有模型，无需修改）

**位置**: `DTOs/ScheduleDto.cs`

```csharp
public class ScheduleSummaryDto
{
    public int Id { get; set; }
    public string Title { get; set; }
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public int PersonnelCount { get; set; }
    public int PositionCount { get; set; }
    public int ShiftCount { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? ConfirmedAt { get; set; }
}
```

## 错误处理

### 1. 草稿不存在

**场景**: 用户尝试查看、确认或删除不存在的草稿

**处理**:
- ISchedulingService 方法应检查草稿是否存在
- 如果不存在，抛出 `InvalidOperationException`
- DraftsViewModel 捕获异常并显示错误对话框
- 刷新草稿列表以确保数据一致性

### 2. 确认草稿失败

**场景**: 确认草稿时发生错误（如数据库错误）

**处理**:
- ISchedulingService.ConfirmScheduleAsync 抛出异常
- DraftsViewModel 捕获异常并显示错误对话框
- 不删除其他草稿
- 保持草稿列表不变

### 3. 删除其他草稿失败

**场景**: 确认草稿成功，但删除其他草稿时部分失败

**处理**:
- 记录错误日志但不中断流程
- 继续删除其他草稿
- 确认操作仍然视为成功
- 刷新草稿列表以显示实际状态

### 4. 网络或数据库错误

**场景**: 加载草稿列表时发生错误

**处理**:
- DraftsViewModel 捕获异常
- 显示错误对话框
- 保持 IsLoading = false
- 允许用户重试

## 测试策略

### 单元测试

**测试目标**: DraftsViewModel 和 SchedulingService

**测试用例**:

1. **LoadDraftsAsync 测试**:
   - 测试成功加载草稿列表
   - 测试空草稿列表
   - 测试加载失败的错误处理

2. **ViewDraftAsync 测试**:
   - 测试导航到 ScheduleResultPage
   - 测试传递正确的草稿 ID

3. **ConfirmDraftAsync 测试**:
   - 测试确认草稿成功
   - 测试确认后删除其他草稿
   - 测试确认失败的错误处理
   - 测试删除其他草稿部分失败的情况

4. **DeleteDraftAsync 测试**:
   - 测试删除草稿成功
   - 测试删除失败的错误处理

5. **ConfirmScheduleAndClearOthersAsync 测试**:
   - 测试确认草稿并清空其他草稿
   - 测试只确认草稿不清空其他草稿
   - 测试删除其他草稿时的错误处理

### 集成测试

**测试目标**: DraftsPage、DraftsViewModel、SchedulingService、IHistoryManagement

**测试用例**:

1. **端到端草稿管理流程**:
   - 创建多个草稿
   - 加载草稿列表
   - 查看草稿详情
   - 确认一个草稿
   - 验证其他草稿被删除
   - 验证草稿列表为空

2. **并发操作测试**:
   - 同时确认多个草稿
   - 验证只有一个草稿被确认
   - 验证其他草稿被删除

### UI 测试

**测试目标**: DraftsPage 的用户交互

**测试用例**:

1. **草稿列表展示**:
   - 验证草稿信息正确显示
   - 验证空状态正确显示
   - 验证加载指示器正确显示

2. **操作按钮交互**:
   - 验证"查看"按钮导航正确
   - 验证"确认"按钮显示确认对话框
   - 验证"删除"按钮显示确认对话框

3. **确认对话框**:
   - 验证对话框文本清楚说明会清空其他草稿
   - 验证"确认"和"取消"按钮功能正确

## 正确性属性

*属性是一个特征或行为，应该在系统的所有有效执行中保持为真——本质上是关于系统应该做什么的正式陈述。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*

### 属性 1: 草稿列表一致性

*对于任何* 草稿列表加载操作，返回的草稿列表应该只包含 ConfirmedAt 字段为 null 的排班记录

**验证**: 需求 1.5

### 属性 2: 导航参数正确性

*对于任何* 草稿查看操作，传递给 ScheduleResultPage 的草稿 ID 应该与用户点击的草稿 ID 相同

**验证**: 需求 2.2

### 属性 3: 确认后清空不变性

*对于任何* 草稿确认操作，确认成功后草稿箱中应该不存在任何其他草稿（除了刚确认的草稿已转为历史记录）

**验证**: 需求 4.3, 4.4

### 属性 4: 确认操作原子性

*对于任何* 草稿确认操作，如果确认失败，则不应该删除任何其他草稿

**验证**: 需求 3.5, 4.5

### 属性 5: 删除操作幂等性

*对于任何* 草稿删除操作，多次删除同一个草稿应该产生相同的结果（草稿不存在）

**验证**: 需求 5.5

### 属性 6: 草稿状态转换单向性

*对于任何* 草稿，一旦被确认转为历史记录，就不应该再出现在草稿列表中

**验证**: 需求 3.3

### 属性 7: UI 状态一致性

*对于任何* 草稿列表操作（加载、确认、删除），操作完成后 UI 展示的草稿列表应该与后端数据一致

**验证**: 需求 1.2, 3.4, 5.3

## 性能考虑

### 1. 草稿列表加载

**优化策略**:
- 使用异步加载避免阻塞 UI
- 显示加载指示器提供用户反馈
- 考虑缓存草稿列表，避免频繁查询数据库

### 2. 批量删除草稿

**优化策略**:
- 使用并行删除提高性能（如果数据库支持）
- 考虑使用事务确保数据一致性
- 记录删除失败但不中断流程

### 3. 导航性能

**优化策略**:
- 使用轻量级导航参数（只传递 ID）
- 在目标页面异步加载详细数据
- 考虑预加载常用数据

## 安全考虑

### 1. 权限验证

**策略**:
- 确保用户有权限查看和操作草稿
- 在服务层验证用户权限（如果有用户系统）

### 2. 数据验证

**策略**:
- 验证草稿 ID 的有效性
- 防止 SQL 注入（使用参数化查询）
- 验证草稿状态（确保是草稿而不是历史记录）

### 3. 并发控制

**策略**:
- 使用乐观锁或悲观锁防止并发修改
- 处理草稿已被其他用户删除的情况
- 提供友好的错误提示

## 可访问性

### 1. 键盘导航

**要求**:
- 所有操作按钮支持键盘访问
- 支持 Tab 键在按钮间导航
- 支持 Enter 键触发按钮操作

### 2. 屏幕阅读器

**要求**:
- 为所有按钮提供清晰的标签
- 为草稿列表项提供完整的描述
- 为加载状态提供语音反馈

### 3. 视觉反馈

**要求**:
- 按钮悬停时提供视觉反馈
- 操作成功/失败时提供明确的视觉提示
- 使用颜色和图标区分不同类型的操作

## 国际化

### 1. 文本本地化

**要求**:
- 所有 UI 文本使用资源文件
- 支持中文和英文（根据项目需求）
- 日期和时间格式本地化

### 2. 错误消息

**要求**:
- 错误消息使用本地化文本
- 提供清晰的错误描述和解决建议

## 依赖关系

### 现有依赖

- **CommunityToolkit.Mvvm**: MVVM 框架，用于 ViewModel 实现
- **Microsoft.Extensions.DependencyInjection**: 依赖注入
- **WinUI 3**: UI 框架

### 新增依赖

无新增依赖

## 部署考虑

### 1. 数据库迁移

**策略**:
- 无需数据库架构变更
- 确保现有草稿数据兼容

### 2. 向后兼容性

**策略**:
- 新增方法不影响现有功能
- 保持现有 API 接口不变
- 提供平滑的升级路径

### 3. 回滚策略

**策略**:
- 新增方法可以独立禁用
- 保留旧的确认流程作为备份
- 提供配置选项控制是否清空其他草稿

## 监控和日志

### 1. 日志记录

**要求**:
- 记录所有草稿操作（加载、查看、确认、删除）
- 记录错误和异常
- 记录性能指标（操作耗时）

### 2. 监控指标

**要求**:
- 草稿列表加载时间
- 确认操作成功率
- 删除操作成功率
- 错误发生频率

## 未来扩展

### 1. 草稿比较

**功能**: 允许用户比较多个草稿，选择最优方案

**实现**: 
- 添加多选功能
- 实现草稿比较视图
- 提供并排对比

### 2. 草稿导出

**功能**: 允许用户导出草稿为文件

**实现**:
- 添加导出按钮
- 支持多种格式（Excel、CSV、JSON）
- 提供批量导出

### 3. 草稿自动清理

**功能**: 自动删除过期的草稿

**实现**:
- 添加草稿过期时间配置
- 实现后台清理任务
- 提供清理通知

### 4. 草稿恢复

**功能**: 允许用户恢复已删除的草稿

**实现**:
- 实现软删除机制
- 添加回收站功能
- 提供恢复操作
