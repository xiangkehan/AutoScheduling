# 需求文档

## 简介

本功能旨在为"按哨位展示"视图添加哨位选择器控件，使用户能够快速切换和搜索不同的哨位。目前系统在按哨位展示排班结果时，只显示当前哨位名称，用户无法方便地切换到其他哨位。本需求将添加一个统一的哨位选择器，支持下拉选择和智能搜索（包括模糊匹配和拼音首字母匹配），提升用户在查看不同哨位排班情况时的效率。

## 术语表

- **哨位选择器（Position Selector）**：用于选择哨位的UI控件，基于AutoSuggestBox实现
- **AutoSuggestBox**：WinUI 3提供的自动建议输入框控件
- **自动联想（Auto-suggestion）**：根据用户输入实时显示匹配的建议项
- **下拉选择（Dropdown Selection）**：点击控件时显示所有可选项的列表
- **模糊搜索（Fuzzy Search）**：支持部分匹配的搜索方式，不区分大小写
- **PositionDto**：哨位数据传输对象，包含哨位的基本信息
- **PositionScheduleData**：哨位排班数据，包含哨位信息和按周显示的排班详情
- **PositionScheduleControl**：显示单个哨位排班详情的用户控件

## 需求

### 需求 1：按哨位展示视图的哨位选择器

**用户故事**：作为用户，我希望在按哨位展示排班结果时能够快速切换到不同的哨位，这样我可以方便地查看各个哨位的排班情况。

#### 验收标准

1. WHEN 用户切换到"按哨位"视图模式 THEN 系统应显示哨位选择器控件
2. WHEN 用户点击哨位选择器 THEN 系统应显示所有参与排班的哨位列表
3. WHEN 用户在哨位选择器中输入文本 THEN 系统应实时过滤并显示匹配的哨位建议
4. WHEN 用户输入的文本与哨位名称部分匹配 THEN 系统应使用模糊匹配算法返回相关结果
5. WHEN 用户输入拼音首字母 THEN 系统应支持拼音首字母模糊匹配（例如：输入"dw"匹配"东门"）
6. WHEN 用户从建议列表中选择一个哨位 THEN 系统应将该哨位设置为选中状态并更新PositionScheduleControl显示
7. WHEN 用户按下回车键且有匹配的建议项 THEN 系统应自动选择第一个匹配项

### 需求 2：智能搜索和模糊匹配

**用户故事**：作为用户，我希望能够通过输入哨位名称的任意部分快速找到目标哨位，即使输入不完整或顺序不完全匹配，这样我可以节省查找时间。

#### 验收标准

1. WHEN 用户输入搜索文本 THEN 系统应对哨位名称进行不区分大小写的模糊匹配
2. WHEN 用户输入哨位名称的连续子串 THEN 系统应返回包含该子串的所有哨位（例如：输入"东门"可以匹配"东门哨位"、"东门岗"）
3. WHEN 用户输入哨位名称的非连续字符 THEN 系统应返回包含这些字符且顺序一致的哨位（例如：输入"dm"可以匹配"东门"的拼音首字母）
4. WHEN 用户输入的文本为空 THEN 系统应显示所有参与排班的哨位
5. WHEN 搜索结果为空 THEN 系统应显示"未找到匹配的哨位"提示
6. WHEN 用户清空搜索文本 THEN 系统应恢复显示所有参与排班的哨位
7. WHEN 系统执行模糊搜索 THEN 搜索响应时间应不超过200毫秒
8. WHEN 有多个匹配结果 THEN 系统应按照匹配度排序，完全匹配的结果排在前面

### 需求 3：哨位选择器UI集成

**用户故事**：作为用户，我希望哨位选择器能够无缝集成到现有的按哨位展示视图中，这样我可以获得一致的用户体验。

#### 验收标准

1. WHEN 用户切换到"按哨位"视图 THEN 系统应在PositionScheduleControl上方显示哨位选择器
2. WHEN 用户选择一个哨位 THEN 系统应更新SelectedPositionSchedule属性并刷新PositionScheduleControl
3. WHEN 用户选择一个哨位 THEN 系统应在哨位选择器中显示该哨位的名称
4. WHEN 哨位选择器获得焦点 THEN 系统应显示所有可用哨位的下拉列表
5. WHEN 没有可用的哨位数据 THEN 系统应显示"暂无哨位数据"提示

### 需求 4：复用现有的搜索基础设施

**用户故事**：作为开发者，我希望能够复用已有的FuzzyMatcher和PinyinHelper类，这样我可以保持代码的一致性并减少重复开发。

#### 验收标准

1. WHEN 实现哨位搜索功能 THEN 系统应使用现有的FuzzyMatcher类进行模糊匹配
2. WHEN 实现拼音匹配功能 THEN 系统应使用现有的PinyinHelper类进行拼音转换
3. WHEN 实现搜索防抖功能 THEN 系统应使用类似PersonnelSearchHelper的模式
4. WHEN 配置搜索选项 THEN 系统应使用FuzzyMatchOptions进行配置
5. WHEN 返回搜索结果 THEN 系统应使用MatchResult数据结构

### 需求 5：无障碍支持

**用户故事**：作为使用辅助技术的用户，我希望哨位选择器能够被屏幕阅读器正确识别和操作，这样我可以无障碍地使用系统。

#### 验收标准

1. WHEN 哨位选择器获得焦点 THEN 屏幕阅读器应朗读控件的用途和当前状态
2. WHEN 用户使用键盘导航建议列表 THEN 系统应支持上下箭头键选择和回车键确认
3. WHEN 建议列表显示 THEN 每个建议项应包含AutomationProperties.Name属性
4. WHEN 哨位选择器状态改变 THEN 系统应通过AutomationProperties.LiveSetting通知辅助技术
5. WHEN 用户使用Tab键导航 THEN 哨位选择器应正确参与焦点顺序

### 需求 6：性能优化

**用户故事**：作为用户，我希望哨位选择器在处理大量哨位数据时仍然保持流畅，这样我可以在任何情况下都能快速完成选择。

#### 验收标准

1. WHEN 参与排班的哨位数量超过50个 THEN 系统应使用虚拟化技术渲染列表
2. WHEN 用户快速输入搜索文本 THEN 系统应使用防抖（debounce）技术减少搜索频率
3. WHEN 系统执行搜索过滤 THEN 搜索算法应在单独的线程中执行以避免UI阻塞
4. WHEN 哨位数据加载 THEN 系统应显示加载指示器
5. WHEN 哨位数据加载失败 THEN 系统应显示错误提示并提供重试选项

### 需求 7：增强的拼音和容错匹配

**用户故事**：作为用户，我希望即使输入有少量错误或使用完整拼音，系统也能准确找到目标哨位，这样我可以更灵活地进行搜索。

#### 验收标准

1. WHEN 用户输入完整拼音 THEN 系统应支持完整拼音匹配（例如：输入"dongmen"匹配"东门"）
2. WHEN 用户输入拼音前缀 THEN 系统应支持拼音前缀匹配（例如：输入"dong"匹配"东门"）
3. WHEN 用户输入包含少量错误的文本 THEN 系统应使用编辑距离算法返回相近的匹配结果（例如：输入"dongmne"匹配"dongmen"）
4. WHEN 用户输入包含空格或特殊字符的文本 THEN 系统应自动标准化并返回正确的匹配结果（例如：输入"东 门！"匹配"东门"）
5. WHEN 系统计算匹配分数 THEN 更精确的匹配应获得更高的分数
6. WHEN 查询词长度小于等于3 THEN 系统应将最大编辑距离设置为1
7. WHEN 查询词长度大于等于4 THEN 系统应将最大编辑距离设置为2
8. WHEN 匹配结果包含多种匹配类型 THEN 系统应按照完全匹配、前缀匹配、子串匹配、拼音匹配、编辑距离匹配、序列匹配的优先级排序

### 需求 8：哨位信息显示

**用户故事**：作为用户，我希望在哨位选择器的建议列表中能够看到哨位的关键信息，这样我可以更准确地选择目标哨位。

#### 验收标准

1. WHEN 建议列表显示哨位项 THEN 系统应显示哨位名称
2. WHEN 建议列表显示哨位项 THEN 系统应显示该哨位的排班班次总数
3. WHEN 建议列表显示哨位项 THEN 系统应使用清晰的视觉层次区分主要信息和次要信息
4. WHEN 用户悬停在建议项上 THEN 系统应提供视觉反馈（高亮显示）
5. WHEN 哨位有特殊标记（如技能要求） THEN 系统应在建议项中显示相应的标签或图标
