# 设计文档

## 概述

本设计文档描述了如何修复测试数据生成器中的重复数据问题。主要通过改进名称生成逻辑、增强唯一性检查机制，以及优化手动指定数据的生成策略来确保所有生成的数据都满足唯一性约束。

## 架构

### 当前问题分析

1. **名称生成逻辑不完善**: 虽然使用了 `HashSet` 来跟踪已使用的名称，但在预定义名称用完后，生成的备用名称（如"技能1"、"人员1"）可能与预定义名称冲突
2. **循环退出条件不明确**: 在 `do-while` 循环中，如果无法找到唯一名称，可能导致无限循环
3. **手动指定数据的重试机制有限**: 当前只尝试12次（遍历所有时段），但没有考虑日期的变化
4. **错误信息不够详细**: 验证阶段虽然能检测重复，但生成阶段没有足够的日志记录

### 解决方案架构

修改 `TestDataGenerator` 类中的以下方法：
- `GenerateSkills()`: 改进技能名称生成逻辑
- `GeneratePersonnel()`: 改进人员名称生成逻辑
- `GeneratePositions()`: 改进哨位名称和地点生成逻辑
- `GenerateHolidayConfigs()`: 确保配置名称唯一
- `GenerateTemplates()`: 确保模板名称唯一
- `GenerateManualAssignments()`: 改进手动指定数据的生成策略

## 组件和接口

### 1. 名称生成器辅助方法

创建通用的名称生成辅助方法，用于生成唯一名称：

```csharp
/// <summary>
/// 生成唯一名称
/// </summary>
/// <param name="availableNames">可用的预定义名称列表</param>
/// <param name="usedNames">已使用的名称集合</param>
/// <param name="fallbackPrefix">备用名称前缀</param>
/// <param name="index">当前索引</param>
/// <returns>唯一的名称</returns>
private string GenerateUniqueName(
    List<string> availableNames,
    HashSet<string> usedNames,
    string fallbackPrefix,
    int index)
```

### 2. 改进的生成方法

#### GenerateSkills()
- 使用 `GenerateUniqueName()` 方法
- 确保备用名称（如"技能1"）不与预定义名称冲突
- 添加最大重试次数限制，避免无限循环

#### GeneratePersonnel()
- 使用 `GenerateUniqueName()` 方法
- 确保备用名称（如"人员1"）不与预定义名称冲突
- 添加最大重试次数限制

#### GeneratePositions()
- 使用 `GenerateUniqueName()` 方法处理哨位名称
- 使用 `GenerateUniqueName()` 方法处理地点名称
- 确保备用名称不与预定义名称冲突

#### GenerateHolidayConfigs()
- 添加名称唯一性检查
- 确保"自定义配置X"格式的名称不会重复

#### GenerateTemplates()
- 添加名称唯一性检查
- 确保模板名称格式不会产生重复

#### GenerateManualAssignments()
- 改进重试策略：先尝试不同时段，再尝试不同日期
- 添加最大重试次数限制
- 在达到重试上限后跳过该条记录
- 记录跳过的记录数量

## 数据模型

无需修改现有数据模型，所有修改都在生成逻辑层面。

## 错误处理

### 1. 名称生成失败
- 当无法生成唯一名称时（达到最大重试次数），抛出 `InvalidOperationException`
- 错误信息应包含：已尝试的次数、当前已使用的名称数量、请求的总数量

### 2. 手动指定生成失败
- 当无法为手动指定找到唯一组合时，跳过该记录
- 在生成完成后，如果跳过的记录数量超过请求数量的10%，记录警告信息

### 3. 验证失败
- 保持现有的验证逻辑
- 在验证阶段检测到重复时，提供详细的错误信息

## 测试策略

### 1. 单元测试（可选）
- 测试 `GenerateUniqueName()` 方法的各种场景
- 测试预定义名称用完后的备用名称生成
- 测试名称冲突时的重试机制

### 2. 集成测试
- 生成小规模测试数据（5个技能、10个人员、8个哨位）
- 验证所有名称唯一
- 验证手动指定数据无重复组合

### 3. 大规模测试
- 生成超过预定义名称数量的数据
- 验证备用名称生成机制正常工作
- 验证所有数据满足唯一性约束

### 4. 边界测试
- 测试请求数量等于预定义名称数量的情况
- 测试请求数量远大于预定义名称数量的情况
- 测试手动指定数据生成时所有时段都被占用的情况

## 实现细节

### 名称生成算法

```
1. 如果 availableNames 列表不为空：
   a. 从列表中随机选择一个名称
   b. 检查是否已被使用
   c. 如果未使用，返回该名称并从列表中移除
   d. 如果已使用，继续尝试下一个

2. 如果 availableNames 列表为空：
   a. 生成格式为 "{fallbackPrefix}{index}" 的名称
   b. 检查是否已被使用
   c. 如果未使用，返回该名称
   d. 如果已使用，递增计数器并重试

3. 如果达到最大重试次数（1000次），抛出异常
```

### 手动指定生成算法

```
1. 随机选择哨位和人员
2. 随机选择日期和时段
3. 检查组合是否已存在
4. 如果存在：
   a. 尝试其他时段（最多12次）
   b. 如果所有时段都被占用，尝试其他日期（最多5次）
   c. 如果仍然失败，跳过该记录
5. 如果不存在，添加到结果列表
6. 记录跳过的数量
```

## 性能考虑

- 使用 `HashSet` 进行 O(1) 的名称查找
- 限制最大重试次数，避免无限循环
- 在手动指定生成中，优先尝试时段变化（成本较低），再尝试日期变化

## 向后兼容性

- 所有修改都在 `TestDataGenerator` 类内部
- 不影响公共 API
- 生成的数据格式保持不变
- 现有的调用代码无需修改
