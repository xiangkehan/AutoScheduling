# 实现计划

- [ ] 1. 创建数据模型和筛选逻辑
  - 创建 `SearchResultItem.cs` 和 `SearchFilters.cs` 数据模型
  - 实现时段名称映射、夜哨判断等辅助方法
  - _需求: 5.1, 5.2, 5.3_

- [ ]* 1.1 为 SearchResultItem 编写单元测试
  - 测试时段名称映射（0-11）
  - 测试夜哨判断逻辑（时段 11, 0, 1, 2）
  - 测试 DisplayText 格式
  - _需求: 5.1, 5.2_

- [ ]* 1.2 为 SearchFilters 编写单元测试
  - 测试 HasAnyFilter 属性
  - 测试 GetSummary() 方法
  - _需求: 4.4_

- [ ] 2. 实现 ViewModel 搜索功能核心逻辑
  - 创建 `ScheduleResultViewModel.Search.cs` partial class
  - 实现搜索相关属性（SearchResults, FocusedShiftId, HasActiveSearch 等）
  - 实现 SearchShiftsAsync() 方法，支持多条件 AND 组合
  - 实现单元格键生成逻辑（格式：shift_{shiftId}_{viewType}）
  - _需求: 1.1, 4.1, 4.2, 4.3, 7.1_

- [ ]* 2.1 编写属性测试：筛选结果一致性
  - **属性 1: 筛选结果一致性**
  - **验证需求: 1.1, 2.2**
  - 验证搜索结果与高亮键集合的一致性

- [ ]* 2.2 编写属性测试：单元格键格式
  - **属性 8: 单元格键格式**
  - **验证需求: 1.8, 7.1**
  - 验证键格式符合 `shift_{shiftId}_{viewType}` 规范

- [ ]* 2.3 编写属性测试：AND 逻辑组合
  - **属性 9: AND 逻辑组合**
  - **验证需求: 4.1, 4.2, 4.3**
  - 验证多个筛选条件的交集逻辑

- [ ] 3. 实现高亮管理功能
  - 实现 UpdateHighlightsAsync() 方法，基于班次 ID 生成高亮键
  - 实现 ApplyFiltersAsync() 方法，整合搜索和高亮逻辑
  - 实现 ResetFiltersAsync() 方法，清除所有状态
  - _需求: 1.1, 1.2, 1.3, 4.6_

- [ ]* 3.1 编写属性测试：高亮状态转换
  - **属性 2: 高亮状态转换**
  - **验证需求: 1.2**
  - 验证切换人员时高亮集合的完全替换

- [ ]* 3.2 编写属性测试：重置幂等性
  - **属性 3: 重置幂等性**
  - **验证需求: 1.3, 4.6**
  - 验证重置后所有状态清空

- [ ] 4. 实现导航和焦点高亮功能
  - 实现导航命令（NavigateToPreviousHighlight, NavigateToNextHighlight）
  - 实现 ScrollToHighlightAsync() 方法，触发滚动事件
  - 实现 SelectSearchResultAsync() 方法，处理焦点高亮
  - 实现导航按钮的启用/禁用逻辑
  - _需求: 1.4, 1.5, 1.6, 2.4, 2.6_

- [ ]* 4.1 编写属性测试：滚动事件触发
  - **属性 4: 滚动事件触发**
  - **验证需求: 1.4**
  - 验证应用筛选后触发滚动事件

- [ ]* 4.2 编写属性测试：导航按钮状态
  - **属性 5: 导航按钮状态**
  - **验证需求: 1.5**
  - 验证导航按钮的启用/禁用逻辑

- [ ]* 4.3 编写属性测试：焦点高亮唯一性
  - **属性 6: 焦点高亮唯一性**
  - **验证需求: 1.6, 2.4, 2.6**
  - 验证任意时刻最多一个焦点高亮

- [ ] 5. 实现视图切换支持
  - 重写 OnViewModeChangedAsync() 方法，支持高亮重映射
  - 实现基于班次 ID 的跨视图坐标查找逻辑
  - 确保视图切换时保持高亮状态
  - _需求: 1.7, 7.2_

- [ ]* 5.1 编写属性测试：跨视图高亮保持
  - **属性 7: 跨视图高亮保持**
  - **验证需求: 1.7**
  - 验证视图切换时班次 ID 集合不变

- [ ]* 5.2 编写属性测试：班次 ID 到坐标映射
  - **属性 19: 班次 ID 到坐标映射**
  - **验证需求: 7.2**
  - 验证能够正确计算坐标

- [ ] 6. 集成搜索功能到主 ViewModel
  - 在 ScheduleResultViewModel 构造函数中调用 InitializeSearchCommands()
  - 更新属性变化监听，支持搜索状态更新
  - 确保与现有冲突管理功能的兼容性
  - _需求: 所有需求_

- [ ]* 6.1 编写集成测试：筛选功能
  - 测试单一筛选条件
  - 测试多个筛选条件组合
  - 测试重置筛选功能

- [ ]* 6.2 编写集成测试：高亮功能
  - 测试高亮键生成和应用
  - 测试视图切换时高亮保持
  - 测试焦点高亮切换

- [x] 7. 创建 UI 结构 - TabView 和搜索结果面板
  - 在 ScheduleResultPage.xaml 中添加 TabView 控件
  - 创建"搜索结果"和"冲突管理"两个标签页
  - 将现有冲突管理内容移到"冲突管理"标签页
  - 实现搜索结果标签页的条件显示（基于 HasActiveSearch）
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 8. 实现搜索结果列表 UI
  - 在搜索结果标签页中添加筛选条件摘要显示
  - 添加结果数量统计显示
  - 创建 ListView 显示搜索结果（使用 SearchResultItem 数据模板）
  - 实现空状态提示（当搜索结果为空时）
  - _需求: 2.1, 2.2, 2.3, 2.5, 4.4_

- [x] 9. 实现搜索结果项数据模板
  - 创建 DataTemplate 显示班次信息（日期、星期、时段、哨位、人员）
  - 添加视觉标识区分夜哨和日哨
  - 添加手动分配标识
  - 添加冲突标识
  - 实现工具提示显示详细信息
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10. 添加导航按钮到搜索结果底部
  - 在搜索结果列表底部添加"上一个"和"下一个"按钮
  - 绑定按钮命令到 ViewModel
  - 实现按钮的启用/禁用状态绑定
  - 添加当前位置指示器（如 "3 / 10"）
  - _需求: 1.5, 1.6_

- [x] 11. 实现事件处理和用户交互
  - 在 ScheduleResultPage.xaml.cs 中添加搜索结果项点击事件处理
  - 实现标签页切换逻辑
  - 确保滚动事件正确触发和处理
  - _需求: 2.4, 3.2, 3.3_

- [x] 12. 实现高亮样式和视觉效果
  - 定义搜索结果高亮样式（背景色、边框等）
  - 定义焦点高亮样式（更明显的边框或背景）
  - 确保高亮样式在不同主题下可见
  - 实现高亮样式的动画过渡（可选）
  - _需求: 1.1, 1.6, 2.4_

- [x] 13. 实现性能优化
  - 为搜索操作添加防抖机制（300ms）
  - 为搜索结果列表启用虚拟化（ItemsRepeater 或 ListView 虚拟化）
  - 添加加载指示器（IsLoading 状态绑定）
  - 优化大数据量场景的性能
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 13.1 编写性能测试：搜索性能
  - **属性 15: 搜索性能约束**
  - **验证需求: 6.1**
  - 验证 1000+ 班次的搜索在 500ms 内完成

- [ ]* 13.2 编写性能测试：防抖机制
  - **属性 16: 防抖机制**
  - **验证需求: 6.2**
  - 验证连续触发时只执行最后一次

- [ ]* 13.3 编写性能测试：视图切换性能
  - **属性 17: 视图切换性能约束**
  - **验证需求: 6.4**
  - 验证视图切换在 300ms 内完成

- [ ] 14. 测试和调试
  - 测试所有视图模式（Grid, ByPosition, ByPersonnel, List）的高亮功能
  - 测试多种筛选条件组合
  - 测试边界情况（空结果、单个结果、大量结果）
  - 测试与冲突管理功能的交互
  - 修复发现的 bug
  - _需求: 所有需求_

- [ ]* 14.1 运行所有属性测试
  - 确保所有 19 个属性测试通过
  - 验证测试覆盖率 > 80%

- [ ]* 14.2 运行所有集成测试
  - 验证组件间交互正确
  - 验证端到端流程

- [ ] 15. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，询问用户是否有问题
