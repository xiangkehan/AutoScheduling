# 需求文档

## 简介

本文档定义了为贪心调度算法添加回溯机制的需求。当前的贪心算法使用MRV（最小剩余值）启发式策略进行人员分配，但在某些情况下会导致部分哨位时段无法分配人员。通过引入回溯机制，系统可以在遇到无解情况时撤销之前的决策并尝试其他分配方案，从而提高排班的完整性，同时保持所有硬约束和软约束不变。

## 术语表

- **贪心调度器 (Greedy Scheduler)**: 基于MRV启发式策略的排班算法核心组件
- **MRV策略 (Minimum Remaining Values Strategy)**: 优先选择候选人员最少的哨位-时段进行分配的启发式策略
- **回溯 (Backtracking)**: 当遇到无解情况时，撤销之前的分配决策并尝试其他选择的算法技术
- **可行性张量 (Feasibility Tensor)**: 三维布尔张量 [哨位, 时段, 人员]，用于快速判断分配方案是否可行
- **硬约束 (Hard Constraints)**: 必须满足的约束条件，包括技能匹配、可用性、单人上哨、一人一哨等
- **软约束 (Soft Constraints)**: 优化目标，包括休息时间、工作量均衡、时段平衡等
- **未分配时段 (Unassigned Slot)**: 无法找到合适人员进行分配的哨位-时段组合
- **分配栈 (Assignment Stack)**: 记录分配历史的数据结构，用于支持回溯操作
- **决策点 (Decision Point)**: 在分配过程中需要从多个候选人员中选择一个的时刻
- **死胡同 (Dead End)**: 当前分配路径导致后续无法继续分配的状态

## 需求

### 需求 1

**用户故事:** 作为系统管理员，我希望贪心调度算法能够在遇到无解情况时自动回溯并尝试其他分配方案，以便提高排班表的完整性。

#### 验收标准

1. WHEN 贪心算法检测到存在未分配且无候选人员的时段 THEN 系统应启动回溯机制
2. WHEN 回溯机制启动 THEN 系统应撤销最近的分配决策并尝试该决策点的下一个候选人员
3. WHEN 回溯深度超过配置的最大回溯深度 THEN 系统应停止回溯并报告无法完全分配
4. WHEN 回溯成功找到完整分配方案 THEN 系统应返回该方案并记录回溯次数
5. WHEN 回溯过程中 THEN 系统应保持所有硬约束和软约束的验证逻辑不变

### 需求 2

**用户故事:** 作为开发人员，我希望系统能够记录每次分配决策的完整状态，以便在需要回溯时能够准确恢复到之前的状态。

#### 验收标准

1. WHEN 系统执行人员分配 THEN 系统应将分配信息压入分配栈
2. WHEN 分配栈记录分配信息 THEN 系统应包含哨位索引、时段索引、人员索引、可行性张量快照和候选人员列表
3. WHEN 系统需要回溯 THEN 系统应从分配栈弹出最近的分配记录
4. WHEN 系统恢复状态 THEN 系统应将可行性张量、MRV策略状态和调度上下文恢复到分配前的状态
5. WHEN 分配栈为空且仍存在未分配时段 THEN 系统应判定为无解并返回部分结果

### 需求 3

**用户故事:** 作为系统管理员，我希望能够配置回溯机制的参数，以便在性能和完整性之间取得平衡。

#### 验收标准

1. WHEN 系统初始化贪心调度器 THEN 系统应允许配置最大回溯深度参数
2. WHEN 系统初始化贪心调度器 THEN 系统应允许配置是否启用回溯机制的开关
3. WHEN 系统初始化贪心调度器 THEN 系统应允许配置每个决策点保留的候选人员数量
4. WHEN 回溯机制被禁用 THEN 系统应使用原有的贪心算法逻辑
5. WHEN 配置参数无效 THEN 系统应使用默认配置值并记录警告

### 需求 4

**用户故事:** 作为系统管理员，我希望在排班过程中能够看到回溯机制的执行情况，以便了解算法的运行状态。

#### 验收标准

1. WHEN 回溯机制启动 THEN 系统应通过进度报告通知用户
2. WHEN 回溯成功 THEN 系统应报告回溯次数和回溯深度
3. WHEN 回溯失败 THEN 系统应报告失败原因和未分配时段的详细信息
4. WHEN 回溯过程中 THEN 系统应定期更新进度百分比
5. WHEN 排班完成 THEN 系统应在统计信息中包含回溯相关的指标

### 需求 5

**用户故事:** 作为开发人员，我希望回溯机制能够智能地选择回溯点，以便提高回溯的效率。

#### 验收标准

1. WHEN 系统检测到死胡同 THEN 系统应分析导致死胡同的关键决策点
2. WHEN 系统选择回溯点 THEN 系统应优先回溯到对当前未分配时段影响最大的决策点
3. WHEN 决策点有多个候选人员 THEN 系统应按照软约束评分从高到低尝试候选人员
4. WHEN 决策点的所有候选人员都已尝试 THEN 系统应继续回溯到更早的决策点
5. WHEN 系统回溯 THEN 系统应避免重复尝试已经失败的分配路径

### 需求 6

**用户故事:** 作为系统管理员，我希望回溯机制不会显著降低排班算法的性能，以便保持良好的用户体验。

#### 验收标准

1. WHEN 回溯机制执行 THEN 系统应使用增量状态恢复而非完全重建状态
2. WHEN 系统记录分配状态 THEN 系统应使用写时复制策略减少内存开销
3. WHEN 回溯深度较大 THEN 系统应限制状态快照的保存频率
4. WHEN 系统执行回溯 THEN 系统应在合理的时间内完成（不超过原算法执行时间的2倍）
5. WHEN 内存使用超过阈值 THEN 系统应自动降低回溯深度或禁用回溯

### 需求 7

**用户故事:** 作为开发人员，我希望回溯机制能够与现有的约束验证和评分系统无缝集成，以便保持代码的一致性。

#### 验收标准

1. WHEN 系统回溯并重新分配 THEN 系统应使用相同的约束验证器验证分配的有效性
2. WHEN 系统选择候选人员 THEN 系统应使用相同的软约束计算器评估候选人员
3. WHEN 系统更新可行性张量 THEN 系统应使用相同的张量操作方法
4. WHEN 系统应用约束 THEN 系统应保持夜哨唯一、时段不连续等约束的一致性
5. WHEN 回溯机制集成 THEN 系统应不修改现有的约束验证和评分逻辑

### 需求 8

**用户故事:** 作为测试人员，我希望能够验证回溯机制的正确性，以便确保算法的可靠性。

#### 验收标准

1. WHEN 系统完成排班 THEN 系统应验证所有分配都满足硬约束
2. WHEN 系统使用回溯 THEN 系统应验证回溯后的状态与回溯前的状态一致
3. WHEN 系统报告无解 THEN 系统应提供详细的诊断信息说明为何无解
4. WHEN 系统执行回溯 THEN 系统应记录回溯日志以便调试
5. WHEN 测试回溯机制 THEN 系统应提供测试用例覆盖各种回溯场景
