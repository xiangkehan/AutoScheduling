# 实现计划

- [ ] 1. 创建核心数据结构
- [ ] 1.1 实现StateSnapshot类
  - 创建StateSnapshot.cs文件
  - 实现可行性张量状态的序列化和反序列化
  - 实现MRV策略状态的保存和恢复
  - 实现调度上下文分配记录的快照
  - 使用写时复制策略优化内存使用
  - _需求: 2.2, 2.4_

- [ ]* 1.2 为StateSnapshot编写属性测试
  - **属性 5: 回溯状态往返一致性**
  - **验证需求: 2.3, 2.4, 8.2**

- [ ] 1.3 实现AssignmentRecord类
  - 创建AssignmentRecord.cs文件
  - 实现候选人员列表管理
  - 实现GetNextCandidate方法
  - 实现HasMoreCandidates属性
  - 集成StateSnapshot
  - _需求: 2.1, 2.2_

- [ ]* 1.4 为AssignmentRecord编写属性测试
  - **属性 4: 分配栈操作正确性**
  - **验证需求: 2.1, 2.2**

- [ ] 1.5 实现AssignmentStack类
  - 创建AssignmentStack.cs文件
  - 实现Push/Pop/Peek操作
  - 实现栈深度限制
  - 实现IsEmpty和Depth属性
  - 实现Clear方法
  - _需求: 2.1, 2.3_

- [ ]* 1.6 为AssignmentStack编写单元测试
  - 测试Push/Pop操作的正确性
  - 测试栈深度限制
  - 测试空栈处理
  - _需求: 2.1, 2.3_

- [ ] 2. 实现回溯配置
- [ ] 2.1 扩展GreedySchedulerConfig类
  - 在GreedyScheduler.cs中添加BacktrackingConfig属性
  - 实现EnableBacktracking开关
  - 实现MaxBacktrackDepth参数
  - 实现MaxCandidatesPerDecision参数
  - 实现EnableSmartBacktrackSelection开关
  - 实现EnablePathMemory开关
  - 实现SnapshotInterval参数
  - 实现MemoryThresholdMB参数
  - 实现LogBacktracking开关
  - 添加配置验证逻辑
  - _需求: 3.1, 3.2, 3.3, 3.5_

- [ ]* 2.2 为配置参数编写属性测试
  - **属性 7: 配置参数有效性**
  - **验证需求: 3.1, 3.2, 3.3, 3.5**

- [ ] 3. 实现回溯统计和进度报告
- [ ] 3.1 创建BacktrackingStatistics类
  - 创建BacktrackingStatistics.cs文件
  - 实现统计字段（总回溯次数、最大深度、成功/失败次数等）
  - 实现统计信息的更新方法
  - 实现统计信息的格式化输出
  - _需求: 4.2, 4.5_

- [ ] 3.2 扩展SchedulingProgressReport类
  - 在SchedulingProgressReport.cs中添加BacktrackingStats属性
  - 添加CurrentBacktrackDepth属性
  - 在SchedulingStage枚举中添加Backtracking和BacktrackingComplete阶段
  - _需求: 4.1, 4.4_

- [ ] 4. 实现BacktrackingEngine核心逻辑
- [ ] 4.1 创建BacktrackingEngine类框架
  - 创建SchedulingEngine/Core/BacktrackingEngine.cs文件
  - 实现构造函数，注入依赖（Context, Tensor, MRV, Validator, Calculator）
  - 初始化AssignmentStack
  - 初始化回溯统计信息
  - _需求: 1.1, 1.2_

- [ ] 4.2 实现死胡同检测逻辑
  - 实现DetectDeadEnd方法
  - 使用MRVStrategy.GetUnassignedWithNoCandidates检测无候选时段
  - 实现死胡同的日志记录
  - _需求: 1.1, 5.1_

- [ ]* 4.3 为死胡同检测编写属性测试
  - **属性 1: 死胡同触发回溯**
  - **验证需求: 1.1, 1.2**

- [ ] 4.4 实现TryAssignWithBacktracking方法
  - 获取可行候选人员列表
  - 使用SoftConstraintCalculator对候选人员评分排序
  - 创建AssignmentRecord并保存状态快照
  - 尝试分配第一个候选人员
  - 如果分配成功，将记录压入AssignmentStack
  - 如果分配失败，尝试下一个候选人员
  - 更新回溯统计信息
  - _需求: 1.2, 5.3_

- [ ] 4.5 实现Backtrack方法
  - 检查回溯深度是否超限
  - 从AssignmentStack弹出最近的分配记录
  - 恢复状态快照
  - 获取下一个候选人员
  - 如果有下一个候选人员，尝试分配
  - 如果没有更多候选人员，递归回溯到更早的决策点
  - 更新回溯统计信息
  - 报告回溯进度
  - _需求: 1.2, 1.3, 5.4_

- [ ]* 4.6 为回溯方法编写属性测试
  - **属性 2: 回溯深度限制**
  - **验证需求: 1.3**

- [ ]* 4.7 为回溯方法编写属性测试
  - **属性 3: 成功回溯的完整性**
  - **验证需求: 1.4**

- [ ] 4.6 实现SelectBacktrackPoint方法（智能回溯）
  - 分析当前未分配时段
  - 识别对这些时段影响最大的决策点
  - 实现启发式评分算法
  - 返回最优回溯点
  - _需求: 5.1, 5.2_

- [ ]* 4.9 为智能回溯编写属性测试
  - **属性 12: 智能回溯点选择**
  - **验证需求: 5.1, 5.2**

- [ ] 4.10 实现RestoreState方法
  - 恢复可行性张量状态
  - 恢复MRV策略的候选计数和分配标记
  - 恢复调度上下文的分配记录
  - 验证状态恢复的完整性
  - _需求: 2.4_

- [ ] 4.11 实现路径记忆机制
  - 创建路径哈希表记录已尝试的路径
  - 在尝试分配前检查路径是否已失败
  - 实现路径哈希算法
  - 实现路径记忆的清理机制
  - _需求: 5.5_

- [ ]* 4.12 为路径记忆编写属性测试
  - **属性 14: 路径记忆避免重复**
  - **验证需求: 5.5**

- [ ] 4.13 实现GetStatistics方法
  - 返回BacktrackingStatistics对象
  - 包含所有回溯相关的统计信息
  - _需求: 4.2, 4.5_

- [ ] 5. 集成回溯机制到GreedyScheduler
- [ ] 5.1 修改GreedyScheduler.PerformGreedyAssignmentsAsync方法
  - 在方法开始时初始化BacktrackingEngine
  - 将原有的分配逻辑包装到TryAssignWithBacktracking中
  - 在检测到死胡同时调用Backtrack方法
  - 实现回溯循环逻辑
  - 处理回溯深度超限的情况
  - _需求: 1.1, 1.2, 1.3_

- [ ] 5.2 实现回溯进度报告
  - 在回溯开始时报告Backtracking阶段
  - 定期更新回溯进度
  - 在回溯完成时报告BacktrackingComplete阶段
  - 在最终结果中包含回溯统计信息
  - _需求: 4.1, 4.2, 4.4, 4.5_

- [ ]* 5.3 为进度报告编写属性测试
  - **属性 9: 回溯进度报告完整性**
  - **验证需求: 4.1, 4.2, 4.5**

- [ ] 5.4 实现禁用回溯时的行为
  - 检查EnableBacktracking配置
  - 如果禁用，使用原有的贪心算法逻辑
  - 确保行为与原始实现一致
  - _需求: 3.4_

- [ ]* 5.5 为禁用回溯编写属性测试
  - **属性 8: 禁用回溯的行为一致性**
  - **验证需求: 3.4**

- [ ] 6. 实现内存管理和性能优化
- [ ] 6.1 实现内存监控
  - 在BacktrackingEngine中添加内存使用监控
  - 定期检查内存使用情况
  - 当超过MemoryThresholdMB时触发自适应调整
  - _需求: 6.5_

- [ ]* 6.2 为内存管理编写属性测试
  - **属性 18: 内存管理自适应**
  - **验证需求: 6.5**

- [ ] 6.3 实现快照保存优化
  - 根据SnapshotInterval配置控制快照保存频率
  - 实现增量快照机制
  - 对于深度回溯，使用稀疏快照策略
  - _需求: 6.3_

- [ ]* 6.4 为快照优化编写属性测试
  - **属性 19: 快照保存频率控制**
  - **验证需求: 6.3**

- [ ] 6.5 实现写时复制优化
  - 在StateSnapshot中实现写时复制策略
  - 只在状态实际改变时复制数据
  - 使用引用计数管理共享状态
  - _需求: 6.2_

- [ ] 7. 实现错误处理和诊断
- [ ] 7.1 创建自定义异常类
  - 创建BacktrackDepthExceededException类
  - 创建StateRestorationException类
  - 实现异常的详细信息属性
  - _需求: 1.3, 2.4_

- [ ] 7.2 实现无解诊断报告
  - 在无解时生成详细的诊断信息
  - 包含未分配时段列表
  - 包含每个时段的候选人员数量
  - 包含回溯历史
  - 包含失败原因分析
  - _需求: 4.3, 8.3_

- [ ]* 7.3 为诊断报告编写属性测试
  - **属性 10: 回溯失败报告完整性**
  - **验证需求: 4.3**

- [ ]* 7.4 为诊断报告编写属性测试
  - **属性 16: 回溯诊断信息完整性**
  - **验证需求: 8.3**

- [ ] 7.5 实现无解判定逻辑
  - 在分配栈为空且有未分配时段时判定无解
  - 返回部分结果
  - 生成诊断报告
  - _需求: 2.5_

- [ ]* 7.6 为无解判定编写属性测试
  - **属性 6: 无解判定正确性**
  - **验证需求: 2.5**

- [ ] 8. 实现日志记录
- [ ] 8.1 实现回溯日志记录
  - 在BacktrackingEngine中添加日志记录功能
  - 记录每次回溯的详细信息（时间、深度、原因、候选人员）
  - 使用现有的日志系统（DebugLogger）
  - 根据LogBacktracking配置控制日志级别
  - _需求: 8.4_

- [ ]* 8.2 为日志记录编写属性测试
  - **属性 17: 回溯日志记录**
  - **验证需求: 8.4**

- [ ] 9. 验证约束一致性
- [ ] 9.1 验证回溯与约束验证的集成
  - 确保回溯后使用相同的ConstraintValidator
  - 验证约束验证逻辑未被修改
  - 测试各种约束场景
  - _需求: 1.5, 7.1, 7.4_

- [ ]* 9.2 为约束一致性编写属性测试
  - **属性 11: 系统组件一致性**
  - **验证需求: 1.5, 7.1, 7.2, 7.3, 7.4**

- [ ]* 9.3 为硬约束保持编写属性测试
  - **属性 15: 回溯后硬约束保持**
  - **验证需求: 8.1**

- [ ] 10. 编写测试数据生成器
- [ ] 10.1 创建SchedulingContextGenerator
  - 创建测试生成器类
  - 实现随机调度上下文生成
  - 支持配置人员、哨位、技能数量
  - 支持配置日期范围
  - _需求: 8.5_

- [ ] 10.2 创建DeadEndScenarioGenerator
  - 创建专门生成死胡同场景的生成器
  - 生成人员不足的场景
  - 生成技能不匹配的场景
  - 生成约束冲突的场景
  - _需求: 8.5_

- [ ] 11. 编写集成测试
- [ ]* 11.1 编写完整排班流程测试
  - 测试从初始化到完成的完整流程
  - 验证回溯与MRV策略的协作
  - 验证回溯与约束验证的协作
  - 测试各种场景（简单、紧张、困难、无解）
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ]* 11.2 编写性能测试
  - 测试回溯对性能的影响
  - 验证执行时间不超过原算法的2倍
  - 验证内存使用在可接受范围内
  - _需求: 6.4_

- [ ] 12. 最终检查点
  - 确保所有测试通过
  - 验证回溯机制在各种场景下的正确性
  - 验证性能和内存使用符合要求
  - 验证与现有系统的集成无问题
  - 如有问题，请向用户报告
