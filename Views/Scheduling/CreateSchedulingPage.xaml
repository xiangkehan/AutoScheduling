<Page
    x:Class="AutoScheduling3.Views.Scheduling.CreateSchedulingPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:AutoScheduling3.ViewModels.Scheduling"
    xmlns:converters="using:AutoScheduling3.Converters"
    xmlns:dto="using:AutoScheduling3.DTOs"
    xmlns:models="using:AutoScheduling3.Models.Constraints"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
    <Page.Resources>
        <converters:IntToVisibilityConverter x:Key="IntToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InvertedBooleanConverter x:Key="InvertedBooleanConverter"/>
        <converters:DateTimeFormatConverter x:Key="DateTimeFormatConverter"/>

        <DataTemplate x:Key="PersonnelListViewTemplate" x:DataType="dto:PersonnelDto">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <SymbolIcon Symbol="Contact"/>
                <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold"/>
                <!-- Display skill count -->
                <TextBlock Text="{x:Bind SkillIds.Count, Mode=OneWay}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="PositionListViewTemplate" x:DataType="dto:PositionDto">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <SymbolIcon Symbol="MapPin"/>
                <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold"/>
                <!-- LocationName not present; use Location -->
                <TextBlock Text="{x:Bind Location}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </DataTemplate>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="24,24,24,12">
            <TextBlock Text="创建排班" Style="{ThemeResource TitleTextBlockStyle}"/>
            <TextBlock Text="通过分步向导完成排班参数配置并执行排班" Style="{ThemeResource BodyTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            <InfoBar Title="从模板加载" Message="已加载模板，请确认日期和名称后直接进入第5步执行排班" Severity="Success"
                     IsOpen="{x:Bind ViewModel.TemplateApplied, Mode=OneWay}" Margin="0,12,0,0"/>
        </StackPanel>

        <!-- Wizard Steps Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24,0,24,0">
            <StackPanel Spacing="16">
                <!-- Step 1: Basic Info -->
                <Grid Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=1, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="步骤 1: 选择时间范围和名称" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        <TextBox Header="排班表名称" Text="{x:Bind ViewModel.ScheduleTitle, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="例如：2024年5月常规排班"/>
                        <CalendarDatePicker Header="开始日期" Date="{x:Bind ViewModel.StartDate, Mode=TwoWay}"/>
                        <CalendarDatePicker Header="结束日期" Date="{x:Bind ViewModel.EndDate, Mode=TwoWay}"/>
                    </StackPanel>
                </Grid>

                <!-- Step 2: Select Personnel -->
                <Grid Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=2, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="步骤 2: 选择参与人员" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <!-- Available -->
                            <ListView Grid.Column="0" Header="可用人员" ItemsSource="{x:Bind ViewModel.AvailablePersonnels, Mode=OneWay}"
                                      SelectionMode="Multiple" ItemTemplate="{StaticResource PersonnelListViewTemplate}" MinHeight="300"
                                      x:Name="AvailablePersonnelList" x:FieldModifier="public"/>
                            <!-- Buttons -->
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="8">
                                <Button Content="&gt;&gt;" ToolTipService.ToolTip="添加选中"
                                        Click="AddPersonnel_Click"/>
                                <Button Content="&lt;&lt;" ToolTipService.ToolTip="移除选中"
                                        Click="RemovePersonnel_Click"/>
                            </StackPanel>
                            <!-- Selected -->
                            <ListView Grid.Column="2" Header="已选人员" ItemsSource="{x:Bind ViewModel.SelectedPersonnels, Mode=OneWay}"
                                      SelectionMode="Multiple" ItemTemplate="{StaticResource PersonnelListViewTemplate}" MinHeight="300"
                                      x:Name="SelectedPersonnelList" x:FieldModifier="public"/>
                        </Grid>
                    </StackPanel>
                </Grid>

                <!-- Step 3: Select Positions -->
                <Grid Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=3, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="步骤 3: 选择参与哨位" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        <Grid ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <!-- Available -->
                            <ListView Grid.Column="0" Header="可用哨位" ItemsSource="{x:Bind ViewModel.AvailablePositions, Mode=OneWay}"
                                      SelectionMode="Multiple" ItemTemplate="{StaticResource PositionListViewTemplate}" MinHeight="300"
                                      x:Name="AvailablePositionsList" x:FieldModifier="public"/>
                            <!-- Buttons -->
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="8">
                                <Button Content="&gt;&gt;" ToolTipService.ToolTip="添加选中"
                                        Click="AddPosition_Click"/>
                                <Button Content="&lt;&lt;" ToolTipService.ToolTip="移除选中"
                                        Click="RemovePosition_Click"/>
                            </StackPanel>
                            <!-- Selected -->
                            <ListView Grid.Column="2" Header="已选哨位" ItemsSource="{x:Bind ViewModel.SelectedPositions, Mode=OneWay}"
                                      SelectionMode="Multiple" ItemTemplate="{StaticResource PositionListViewTemplate}" MinHeight="300"
                                      x:Name="SelectedPositionsList" x:FieldModifier="public"/>
                        </Grid>
                    </StackPanel>
                </Grid>

                <!-- Step 4: Configure Constraints -->
                <Grid Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=4, Mode=OneWay}">
                    <StackPanel Spacing="24">
                        <TextBlock Text="步骤 4: 配置约束" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        
                        <!-- Loading Indicator -->
                        <StackPanel Spacing="12" HorizontalAlignment="Center" 
                                    Visibility="{x:Bind ViewModel.IsLoadingConstraints, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}">
                            <ProgressRing IsActive="True" Width="48" Height="48"/>
                            <TextBlock Text="正在加载约束数据..." Style="{ThemeResource BodyTextBlockStyle}"/>
                        </StackPanel>

                        <!-- Content -->
                        <StackPanel Spacing="12" 
                                    Visibility="{x:Bind ViewModel.IsLoadingConstraints, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse, Mode=OneWay}">
                            
                            <!-- Holiday Config -->
                            <StackPanel Spacing="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                        BorderThickness="1" Padding="12" CornerRadius="{StaticResource ControlCornerRadius}">
                                <TextBlock Text="休息日配置" Style="{ThemeResource BaseTextBlockStyle}" FontWeight="SemiBold"/>
                                <ToggleSwitch IsOn="{x:Bind ViewModel.UseActiveHolidayConfig, Mode=TwoWay}" 
                                              OffContent="使用自定义配置" OnContent="使用当前活动配置"/>
                                
                                <!-- Empty State for Holiday Configs -->
                                <InfoBar Severity="Warning" IsOpen="True" 
                                         Visibility="{x:Bind ViewModel.HolidayConfigs.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=0, Mode=OneWay}"
                                         Message="没有找到休息日配置。请前往设置页面创建休息日配置。"/>
                                
                                <ComboBox Header="选择一个休息日配置" 
                                          ItemsSource="{x:Bind ViewModel.HolidayConfigs, Mode=OneWay}"
                                          SelectedValue="{x:Bind ViewModel.SelectedHolidayConfigId, Mode=TwoWay, FallbackValue=-1}"
                                          SelectedValuePath="Id" DisplayMemberPath="ConfigName"
                                          IsEnabled="{x:Bind ViewModel.UseActiveHolidayConfig, Converter={StaticResource InvertedBooleanConverter}, Mode=OneWay}"
                                          Visibility="{x:Bind ViewModel.HolidayConfigs.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter='&gt;0', Mode=OneWay}"/>
                            </StackPanel>

                            <!-- Fixed Position Rules -->
                            <StackPanel Spacing="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                        BorderThickness="1" Padding="12" CornerRadius="{StaticResource ControlCornerRadius}">
                                <TextBlock Text="定岗规则" Style="{ThemeResource BaseTextBlockStyle}" FontWeight="SemiBold"/>
                                
                                <!-- Empty State for Fixed Rules -->
                                <TextBlock Text="没有找到定岗规则" 
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           Visibility="{x:Bind ViewModel.FixedPositionRules.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=0, Mode=OneWay}"/>
                                
                                <ListView ItemsSource="{x:Bind ViewModel.FixedPositionRules, Mode=OneWay}" 
                                          SelectionMode="None" MaxHeight="200"
                                          Visibility="{x:Bind ViewModel.FixedPositionRules.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter='&gt;0', Mode=OneWay}">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="models:FixedPositionRule">
                                            <CheckBox Content="{x:Bind Description}" IsChecked="{x:Bind IsEnabled, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackPanel>

                            <!-- Manual Assignments -->
                            <StackPanel Spacing="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                                        BorderThickness="1" Padding="12" CornerRadius="{StaticResource ControlCornerRadius}">
                                <TextBlock Text="手动指定" Style="{ThemeResource BaseTextBlockStyle}" FontWeight="SemiBold"/>
                                
                                <!-- Empty State for Manual Assignments -->
                                <TextBlock Text="在当前日期范围内没有找到手动指定" 
                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                           Visibility="{x:Bind ViewModel.ManualAssignments.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=0, Mode=OneWay}"/>
                                
                                <ListView ItemsSource="{x:Bind ViewModel.ManualAssignments, Mode=OneWay}" 
                                          SelectionMode="None" MaxHeight="200"
                                          Visibility="{x:Bind ViewModel.ManualAssignments.Count, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter='&gt;0', Mode=OneWay}">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ManualAssignment">
                                            <CheckBox IsChecked="{x:Bind IsEnabled, Mode=TwoWay}">
                                                <TextBlock>
                                                    <Run Text="{x:Bind Date, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter='yyyy-MM-dd'}"/>
                                                    <Run Text=" - "/>
                                                    <Run Text="{x:Bind PersonalId}"/>
                                                    <Run Text=" -> "/>
                                                    <Run Text="{x:Bind PositionId}"/>
                                                </TextBlock>
                                            </CheckBox>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Grid>

                <!-- Step 5: Summary -->
                <Grid Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=5, Mode=OneWay}">
                    <StackPanel Spacing="12">
                        <TextBlock Text="步骤 5: 确认参数并执行" Style="{ThemeResource SubtitleTextBlockStyle}"/>
                        <ItemsRepeater ItemsSource="{x:Bind ViewModel.SummarySections, Mode=OneWay}">
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:SummarySection">
                                    <InfoBar Title="{x:Bind Header}" Severity="Informational" IsOpen="True" Margin="0,0,0,8">
                                        <InfoBar.Content>
                                            <ItemsRepeater ItemsSource="{x:Bind Lines}">
                                                <ItemsRepeater.ItemTemplate>
                                                    <DataTemplate x:DataType="x:String">
                                                        <TextBlock Text="{x:Bind}" Style="{ThemeResource BodyTextBlockStyle}"/>
                                                    </DataTemplate>
                                                </ItemsRepeater.ItemTemplate>
                                            </ItemsRepeater>
                                        </InfoBar.Content>
                                    </InfoBar>
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </ScrollViewer>

        <!-- Navigation Buttons -->
        <Grid Grid.Row="2" Padding="24" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderThickness="0,1,0,0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button Content="取消" Command="{x:Bind ViewModel.CancelCommand}" Grid.Column="0"/>

            <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="2">
                <Button Content="上一步" Command="{x:Bind ViewModel.PreviousStepCommand}"
                        Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter='&gt;1', Mode=OneWay}"/>
                <Button Content="下一步" Command="{x:Bind ViewModel.NextStepCommand}" Style="{ThemeResource AccentButtonStyle}"
                        Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter='&lt;5', Mode=OneWay}"/>
                <Button Content="保存为模板" Command="{x:Bind ViewModel.SaveAsTemplateCommand}"
                        Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=5, Mode=OneWay}"/>
                <Button Content="开始排班" Command="{x:Bind ViewModel.ExecuteSchedulingCommand}" Style="{ThemeResource AccentButtonStyle}"
                        Visibility="{x:Bind ViewModel.CurrentStep, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=5, Mode=OneWay}">
                    <Button.Flyout>
                        <Flyout>
                            <StackPanel Spacing="8">
                                <TextBlock Text="正在执行排班..." Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                                <ProgressRing IsActive="{x:Bind ViewModel.IsExecuting, Mode=OneWay}"/>
                            </StackPanel>
                        </Flyout>
                    </Button.Flyout>
                </Button>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
