# 人员服务

<cite>
**Referenced Files in This Document**  
- [PersonnelService.cs](file://Services/PersonnelService.cs)
- [PersonnelMapper.cs](file://DTOs/Mappers/PersonnelMapper.cs)
- [IPersonalRepository.cs](file://Data/Interfaces/IPersonalRepository.cs)
- [ISkillRepository.cs](file://Data/Interfaces/ISkillRepository.cs)
- [PersonnelViewModel.cs](file://ViewModels/DataManagement/PersonnelViewModel.cs)
- [App.xaml.cs](file://App.xaml.cs)
- [ServiceCollectionExtensions.cs](file://Extensions/ServiceCollectionExtensions.cs)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件分析](#核心组件分析)
3. [服务方法实现](#服务方法实现)
4. [关键业务规则](#关键业务规则)
5. [MVVM架构交互](#mvvm架构交互)
6. [依赖注入配置](#依赖注入配置)

## 简介
人员服务(PersonnelService)是自动排班系统中的核心业务组件，负责人员数据的全生命周期管理。该服务实现了人员信息的增删改查、搜索、可用性筛选和技能匹配验证等关键功能。服务采用分层架构设计，通过依赖注入与仓储层、映射器等组件解耦，确保了代码的可维护性和可测试性。

## 核心组件分析

### 人员服务架构
人员服务通过依赖注入获取其所需的所有依赖项，包括人员仓储(IPersonalRepository)、技能仓储(ISkillRepository)、职位仓储(IPositionRepository)和人员映射器(PersonnelMapper)。这种设计模式实现了关注点分离，使服务专注于业务逻辑而非数据访问细节。

```mermaid
classDiagram
class PersonnelService {
-IPersonalRepository _repository
-ISkillRepository _skillRepository
-IPositionRepository _positionRepository
-PersonnelMapper _mapper
+GetAllAsync() Task~PersonnelDto[]~
+CreateAsync(dto) Task~PersonnelDto~
+UpdateAsync(id, dto) Task
+DeleteAsync(id) Task
+SearchAsync(keyword) Task~PersonnelDto[]~
+GetAvailablePersonnelAsync() Task~PersonnelDto[]~
+ValidatePersonnelSkillsAsync(personnelId, positionId) Task~bool~
}
class IPersonnelService {
<<interface>>
+GetAllAsync() Task~PersonnelDto[]~
+GetByIdAsync(id) Task~PersonnelDto?~
+CreateAsync(dto) Task~PersonnelDto~
+UpdateAsync(id, dto) Task
+DeleteAsync(id) Task
+SearchAsync(keyword) Task~PersonnelDto[]~
+GetAvailablePersonnelAsync() Task~PersonnelDto[]~
+ValidatePersonnelSkillsAsync(personnelId, positionId) Task~bool~
}
class IPersonalRepository {
<<interface>>
+GetAllAsync() Task~Personal[]~
+GetByIdAsync(id) Task~Personal?~
+CreateAsync(model) Task~int~
+UpdateAsync(model) Task
+DeleteAsync(id) Task
+SearchByNameAsync(keyword) Task~Personal[]~
+UpdateIntervalCountsAsync(personnelId, recentShiftInterval, recentHolidayInterval, periodIntervals) Task
+GetPersonnelByIdsAsync(ids) Task~Personal[]~
}
class ISkillRepository {
<<interface>>
+GetByIdsAsync(ids) Task~Skill[]~
+SearchByNameAsync(keyword) Task~Skill[]~
+NameExistsAsync(name, excludeId) Task~bool~
}
class PersonnelMapper {
-ISkillRepository _skillRepository
-IPositionRepository _positionRepository
+ToDto(model) PersonnelDto
+ToDtoAsync(model) Task~PersonnelDto~
+ToDtoListAsync(models) Task~PersonnelDto[]~
+ToModel(dto) Personal
+UpdateModel(model, dto) void
}
PersonnelService --> IPersonnelService : "实现"
PersonnelService --> IPersonalRepository : "使用"
PersonnelService --> ISkillRepository : "使用"
PersonnelService --> IPositionRepository : "使用"
PersonnelService --> PersonnelMapper : "使用"
PersonnelMapper --> ISkillRepository : "使用"
PersonnelMapper --> IPositionRepository : "使用"
```

**Diagram sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L14-L193)
- [IPersonnelService.cs](file://Services/Interfaces/IPersonnelService.cs#L9-L50)
- [IPersonalRepository.cs](file://Data/Interfaces/IPersonalRepository.cs#L9-L25)
- [ISkillRepository.cs](file://Data/Interfaces/ISkillRepository.cs#L9-L25)
- [PersonnelMapper.cs](file://DTOs/Mappers/PersonnelMapper.cs#L14-L203)

**Section sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L14-L193)
- [IPersonnelService.cs](file://Services/Interfaces/IPersonnelService.cs#L9-L50)

## 服务方法实现

### 核心CRUD方法
人员服务提供了完整的CRUD操作，每个方法都包含严格的数据验证和业务规则检查。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "PersonnelService"
participant Mapper as "PersonnelMapper"
participant Repository as "IPersonalRepository"
participant SkillRepo as "ISkillRepository"
Client->>Service : CreateAsync(dto)
Service->>Service : ValidateCreateDto(dto)
Service->>SkillRepo : ValidateSkillIdsAsync(dto.SkillIds)
SkillRepo-->>Service : 验证结果
Service->>Repository : ValidatePositionIdAsync(dto.PositionId)
Repository-->>Service : 验证结果
Service->>Mapper : ToModel(dto)
Mapper-->>Service : Personal model
Service->>Repository : CreateAsync(model)
Repository-->>Service : 新ID
Service->>Mapper : ToDtoAsync(model)
Mapper-->>Service : PersonnelDto
Service-->>Client : 返回创建的DTO
```

**Diagram sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L60-L80)
- [PersonnelMapper.cs](file://DTOs/Mappers/PersonnelMapper.cs#L120-L140)
- [IPersonalRepository.cs](file://Data/Interfaces/IPersonalRepository.cs#L15-L20)

**Section sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L60-L80)

### 数据验证规则
服务在创建和更新人员时执行严格的数据验证，确保数据的完整性和一致性。

```mermaid
flowchart TD
Start([CreateAsync/UpdateAsync]) --> ValidateBasic["验证基础数据"]
ValidateBasic --> NameValid{"姓名有效?"}
NameValid --> |否| ThrowError1["抛出ArgumentException"]
NameValid --> |是| SkillValid{"技能ID有效?"}
SkillValid --> |否| ThrowError2["抛出ArgumentException"]
SkillValid --> |是| PositionValid["验证职位ID存在"]
PositionValid --> |无效| ThrowError3["抛出ArgumentException"]
PositionValid --> |有效| BusinessRule["执行业务规则验证"]
BusinessRule --> SkillCheck["验证技能ID有效性"]
SkillCheck --> PositionCheck["验证职位ID有效性"]
PositionCheck --> Convert["转换为Model"]
Convert --> Save["保存到仓储"]
Save --> Return["返回DTO"]
Return --> End([方法结束])
ThrowError1 --> End
ThrowError2 --> End
ThrowError3 --> End
```

**Diagram sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L140-L190)
- [PersonnelService.cs](file://Services/PersonnelService.cs#L82-L138)

**Section sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L82-L138)

## 关键业务规则

### 可用人员筛选
`GetAvailablePersonnelAsync`方法实现了筛选可用人员的业务规则，只返回在职且可用的人员。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "PersonnelService"
participant Repository as "IPersonalRepository"
participant Mapper as "PersonnelMapper"
Client->>Service : GetAvailablePersonnelAsync()
Service->>Repository : GetAllAsync()
Repository-->>Service : 所有人员列表
Service->>Service : 过滤 IsAvailable && !IsRetired
Service->>Mapper : ToDtoListAsync(可用人员)
Mapper-->>Service : DTO列表
Service-->>Client : 返回可用人员DTO列表
```

**Diagram sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L150-L160)

**Section sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L150-L160)

### 人员技能验证
`ValidatePersonnelSkillsAsync`方法实现了人员技能匹配的核心业务规则，用于验证特定人员是否具备担任特定职位所需的全部技能。

```mermaid
flowchart TD
Start([ValidatePersonnelSkillsAsync]) --> GetPersonnel["获取人员信息"]
GetPersonnel --> PersonnelExist{"人员存在?"}
PersonnelExist --> |否| ReturnFalse["返回false"]
PersonnelExist --> |是| CheckStatus["检查人员状态"]
CheckStatus --> Available{"可用且未退役?"}
Available --> |否| ReturnFalse
Available --> |是| GetPosition["获取职位信息"]
GetPosition --> PositionExist{"职位存在?"}
PositionExist --> |否| ReturnFalse
PositionExist --> |是| CheckSkills["检查技能匹配"]
CheckSkills --> RequiredSkills{"有技能要求?"}
RequiredSkills --> |否| ReturnTrue["返回true"]
RequiredSkills --> |是| PersonnelSkills{"人员有技能?"}
PersonnelSkills --> |否| ReturnFalse
PersonnelSkills --> |是| ValidateMatch["验证技能匹配"]
ValidateMatch --> AllMatch{"包含所有所需技能?"}
AllMatch --> |是| ReturnTrue
AllMatch --> |否| ReturnFalse
ReturnTrue --> End([返回true])
ReturnFalse --> End([返回false])
```

**Diagram sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L162-L189)

**Section sources**
- [PersonnelService.cs](file://Services/PersonnelService.cs#L162-L189)

## MVVM架构交互

### 与PersonnelViewModel的交互
人员服务在MVVM架构中与PersonnelViewModel紧密协作，为UI层提供数据和业务逻辑支持。

```mermaid
sequenceDiagram
participant View as "PersonnelPage"
participant ViewModel as "PersonnelViewModel"
participant Service as "PersonnelService"
View->>ViewModel : LoadDataAsync()
ViewModel->>Service : GetAllAsync()
Service-->>ViewModel : 人员DTO列表
ViewModel->>ViewModel : 更新Items集合
View->>ViewModel : CreateCommand.Execute()
ViewModel->>Service : CreateAsync(NewPersonnel)
Service-->>ViewModel : 创建的人员DTO
ViewModel->>ViewModel : 添加到Items集合
View->>ViewModel : EditCommand.Execute()
ViewModel->>ViewModel : 设置EditingPersonnel
View->>ViewModel : SaveCommand.Execute()
ViewModel->>Service : UpdateAsync(SelectedItem.Id, EditingPersonnel)
Service-->>ViewModel : 完成
ViewModel->>ViewModel : 重新加载数据
```

**Diagram sources**
- [PersonnelViewModel.cs](file://ViewModels/DataManagement/PersonnelViewModel.cs#L100-L140)
- [PersonnelService.cs](file://Services/PersonnelService.cs#L40-L60)

**Section sources**
- [PersonnelViewModel.cs](file://ViewModels/DataManagement/PersonnelViewModel.cs#L100-L140)

## 依赖注入配置

### 服务注册
人员服务通过依赖注入容器进行配置和管理，确保在整个应用程序生命周期中的一致性和可管理性。

```mermaid
classDiagram
class App {
-IServiceProvider ServiceProvider
+ConfigureServices() void
+InitializeServicesAsync() Task
}
class ServiceCollectionExtensions {
+AddApplicationServices(services, databasePath) IServiceCollection
+AddBusinessServices(services) IServiceCollection
+AddRepositories(services, databasePath) IServiceCollection
+AddMappers(services) IServiceCollection
+AddHelperServices(services) IServiceCollection
+AddViewModels(services) IServiceCollection
}
class ServiceCollection {
+AddSingleton~TService, TImplementation~() IServiceCollection
+AddTransient~TService~() IServiceCollection
}
App --> ServiceCollectionExtensions : "调用"
ServiceCollectionExtensions --> ServiceCollection : "配置"
ServiceCollection --> PersonnelService : "注册"
ServiceCollection --> PersonnelMapper : "注册"
ServiceCollection --> IPersonalRepository : "注册"
ServiceCollection --> ISkillRepository : "注册"
```

**Diagram sources**
- [App.xaml.cs](file://App.xaml.cs#L40-L60)
- [ServiceCollectionExtensions.cs](file://Extensions/ServiceCollectionExtensions.cs#L70-L130)

**Section sources**
- [App.xaml.cs](file://App.xaml.cs#L40-L60)
- [ServiceCollectionExtensions.cs](file://Extensions/ServiceCollectionExtensions.cs#L70-L130)