# 数据绑定转换器

<cite>
**本文档引用的文件**
- [BoolToVisibilityConverter.cs](file://Converters/BoolToVisibilityConverter.cs)
- [NullToVisibilityConverter.cs](file://Converters/NullToVisibilityConverter.cs)
- [ConflictTypeToColorConverter.cs](file://Converters/ConflictTypeToColorConverter.cs)
- [DiffTypeToColorConverter.cs](file://Converters/DiffTypeToColorConverter.cs)
- [DateTimeFormatConverter.cs](file://Converters/DateTimeFormatConverter.cs)
- [PeriodIndexToTimeConverter.cs](file://Converters/PeriodIndexToTimeConverter.cs)
</cite>

## 目录
1. [简介](#简介)
2. [可见性转换器](#可见性转换器)
   - [BoolToVisibilityConverter](#booltovisibilityconverter)
   - [NullToVisibilityConverter](#nulltovisibilityconverter)
3. [颜色映射转换器](#颜色映射转换器)
   - [ConflictTypeToColorConverter](#conflicttypetocolorconverter)
   - [DiffTypeToColorConverter](#difftypetocolorconverter)
4. [时间格式转换器](#时间格式转换器)
   - [DateTimeFormatConverter](#datetimeformatconverter)
   - [PeriodIndexToTimeConverter](#periodindextotimeconverter)
5. [总结](#总结)

## 简介
本系统包含多个数据绑定转换器，用于在UI层实现数据到视觉表现的转换。这些转换器遵循WPF/UWP的数据绑定机制，通过实现`IValueConverter`接口，将业务数据转换为UI元素的可见性、颜色、文本格式等属性。本文档详细说明核心转换器的功能实现、应用场景、XAML绑定示例、参数说明及异常处理策略。

## 可见性转换器

### BoolToVisibilityConverter
`BoolToVisibilityConverter` 将布尔值转换为UI元素的可见性状态，是控制UI元素显示/隐藏的核心工具。

**功能机制**：
- 默认情况下，`true` 转换为 `Visibility.Visible`，`false` 转换为 `Visibility.Collapsed`
- 支持两种方式实现逻辑反转：
  1. 通过 `Inverted` 属性（XAML中可直接设置）
  2. 通过参数 `"Inverse"`（在Binding中传递）

**XAML绑定示例**：
```xml
<!-- 基本用法 -->
<TextBlock Text="正常显示内容" 
           Visibility="{Binding IsActive, Converter={StaticResource BoolToVisibilityConverter}}"/>

<!-- 使用Inverted属性 -->
<TextBlock Text="反向显示内容" 
           Visibility="{Binding IsHidden, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}"/>

<!-- XAML中直接设置Inverted属性 -->
<local:BoolToVisibilityConverter x:Key="InvertedBoolToVis" Inverted="True"/>
<TextBlock Text="使用Inverted属性" 
           Visibility="{Binding IsReady, Converter={StaticResource InvertedBoolToVis}}"/>
```

**参数说明**：
- `Inverted` (属性): 布尔值，设置转换器的全局反转状态
- `parameter` (参数): 字符串，当值为 `"Inverse"` 时启用反转逻辑

**异常处理策略**：
- 输入值非布尔类型时，返回 `Visibility.Collapsed`
- `ConvertBack` 方法支持将 `Visibility` 转换回布尔值，遵循相同的反转逻辑
- 对无效的 `parameter` 类型静默处理，不影响主逻辑

**Section sources**
- [BoolToVisibilityConverter.cs](file://Converters/BoolToVisibilityConverter.cs#L10-L40)

### NullToVisibilityConverter
`NullToVisibilityConverter` 根据对象是否为null或集合是否为空来控制UI元素的可见性。

**功能机制**：
- 处理两种情况：普通对象（null检查）和集合对象（Count == 0检查）
- 支持通过参数 `"invert"` 实现逻辑反转
- 非null且非空集合时显示元素，否则隐藏

**XAML绑定示例**：
```xml
<!-- 显示非空数据的提示 -->
<TextBlock Text="有数据待处理" 
           Visibility="{Binding DataList, Converter={StaticResource NullToVisibilityConverter}}"/>

<!-- 显示空状态的提示 -->
<TextBlock Text="暂无数据" 
           Visibility="{Binding DataList, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=invert}"/>

<!-- 检查单个对象 -->
<Border Visibility="{Binding SelectedItem, Converter={StaticResource NullToVisibilityConverter}}">
    <TextBlock Text="{Binding SelectedItem.Name}"/>
</Border>
```

**参数说明**：
- `parameter`: 字符串，当值为 `"invert"` 时启用反转逻辑（空/Null时显示，非空/非Null时隐藏）

**异常处理策略**：
- 输入值为null时，视为"空"状态
- 实现了 `ICollection` 接口的对象通过 `Count` 属性判断是否为空
- `ConvertBack` 方法未实现，抛出 `NotImplementedException`，表明此转换器为单向转换

**Section sources**
- [NullToVisibilityConverter.cs](file://Converters/NullToVisibilityConverter.cs#L9-L39)

## 颜色映射转换器

### ConflictTypeToColorConverter
`ConflictTypeToColorConverter` 将冲突类型字符串映射为相应的颜色画笔，用于可视化显示不同类型的调度冲突。

**功能机制**：
- 接收字符串类型的冲突类型标识
- 使用 `switch` 表达式将不同冲突类型映射到预定义的颜色
- 返回 `SolidColorBrush` 对象，可直接用于UI元素的背景或前景色

**XAML绑定示例**：
```xml
<!-- 用于单元格背景色 -->
<Border Background="{Binding ConflictType, Converter={StaticResource ConflictTypeToColorConverter}}">
    <TextBlock Text="{Binding ConflictDescription}"/>
</Border>

<!-- 用于文本前景色 -->
<TextBlock Text="冲突详情" 
           Foreground="{Binding ConflictType, Converter={StaticResource ConflictTypeToColorConverter}}"/>

<!-- 与样式结合使用 -->
<Style x:Key="ConflictHighlightStyle" TargetType="Border">
    <Setter Property="Background" 
            Value="{Binding ConflictType, Converter={StaticResource ConflictTypeToColorConverter}}"/>
</Style>
```

**映射关系**：
- `"hard"` → 红色 (表示硬性冲突，必须解决)
- `"soft"` → 橙色 (表示软性冲突，建议解决)
- `"unassigned"` → 灰色 (表示未分配人员)
- `"info"` → 蓝色 (表示信息性提示)
- 其他/无效值 → 黄色 (默认颜色)
- 输入非字符串类型 → 透明色

**异常处理策略**：
- 输入值非字符串类型时，返回透明色画笔
- 未知的冲突类型返回黄色画笔作为默认值
- `ConvertBack` 方法未实现，抛出 `NotImplementedException`，表明此转换器为单向转换

**Section sources**
- [ConflictTypeToColorConverter.cs](file://Converters/ConflictTypeToColorConverter.cs#L10-L33)

### DiffTypeToColorConverter
`DiffTypeToColorConverter` 将差异类型字符串映射为相应的颜色值，用于高亮显示调度方案的变更。

**功能机制**：
- 将中文描述的变更类型转换为ARGB颜色值
- 使用 `switch` 表达式实现类型到颜色的映射
- 返回 `Windows.UI.Color` 结构体，适用于需要颜色值而非画笔的场景

**XAML绑定示例**：
```xml
<!-- 用于动态设置背景色 -->
<Border Background="{Binding DiffType, Converter={StaticResource DiffTypeToColorConverter}}">
    <TextBlock Text="{Binding ChangeDescription}"/>
</Border>

<!-- 与ColorToBrushConverter结合使用 -->
<local:ColorToBrushConverter x:Key="ColorToBrush"/>
<Border Background="{Binding DiffType, Converter={StaticResource DiffTypeToColorConverter}, Converter={StaticResource ColorToBrush}}">
    <TextBlock Text="{Binding ChangeDescription}"/>
</Border>
```

**映射关系**：
- `"新增班次"` → 浅绿色 (RGB: 223,246,221)
- `"删除班次"` → 浅红色 (RGB: 253,231,233)
- `"人员变更"` → 浅黄色 (RGB: 255,244,206)
- 其他/无效值 → 浅灰色 (RGB: 238,238,238)

**异常处理策略**：
- 输入值为null时，使用空字符串作为默认值
- 未知的差异类型返回浅灰色作为默认值
- `ConvertBack` 方法不支持，抛出 `NotSupportedException`，明确表示不可逆转换

**Section sources**
- [DiffTypeToColorConverter.cs](file://Converters/DiffTypeToColorConverter.cs#L6-L21)

## 时间格式转换器

### DateTimeFormatConverter
`DateTimeFormatConverter` 提供灵活的日期时间格式化功能，支持自定义格式字符串。

**功能机制**：
- 支持 `DateTime` 和 `DateTimeOffset` 两种时间类型
- 默认格式为 `"yyyy-MM-dd HH:mm"`
- 可通过 `parameter` 参数指定自定义格式字符串
- 支持双向转换：格式化显示和解析回时间对象

**XAML绑定示例**：
```xml
<!-- 使用默认格式 -->
<TextBlock Text="{Binding StartTime, Converter={StaticResource DateTimeFormatConverter}}"/>

<!-- 使用自定义格式 -->
<TextBlock Text="{Binding StartTime, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter=yyyy年MM月dd日 HH:mm}"/>

<!-- 显示仅日期 -->
<TextBlock Text="{Binding DateOnly, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter=MM-dd}"/>

<!-- 显示仅时间 -->
<TextBlock Text="{Binding TimeOnly, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter=HH:mm}"/>
```

**参数说明**：
- `parameter`: 字符串，指定日期时间格式化模式（如 `"yyyy-MM-dd"`、`"HH:mm"` 等）

**异常处理策略**：
- 输入值非时间类型时，返回空字符串
- 格式化参数为空或空白时，使用默认格式
- `ConvertBack` 方法尝试解析字符串为 `DateTime`，失败时返回 `DateTime.MinValue`
- 对 `DateTimeOffset` 类型提供与 `DateTime` 相同的处理逻辑

**Section sources**
- [DateTimeFormatConverter.cs](file://Converters/DateTimeFormatConverter.cs#L8-L49)

### PeriodIndexToTimeConverter
`PeriodIndexToTimeConverter` 将时段索引转换为可读的时间范围文本，用于显示2小时制的时段划分。

**功能机制**：
- 接收0-11的整数索引值，代表一天中的12个2小时时段
- 计算起始和结束小时，格式化为 `"HH:00-HH:00"` 的字符串
- 使用 `D2` 格式化确保小时数为两位数
- 索引超出有效范围时返回 "未知时段"

**XAML绑定示例**：
```xml
<!-- 显示时段标题 -->
<TextBlock Text="{Binding PeriodIndex, Converter={StaticResource PeriodIndexToTimeConverter}}"/>

<!-- 用于列表标题 -->
<ListView.ItemTemplate>
    <DataTemplate>
        <StackPanel>
            <TextBlock Text="{Binding PeriodIndex, Converter={StaticResource PeriodIndexToTimeConverter}}" 
                      Style="{StaticResource HeaderTextBlockStyle}"/>
            <ItemsControl ItemsSource="{Binding Shifts}"/>
        </StackPanel>
    </DataTemplate>
</ListView.ItemTemplate>
```

**计算逻辑**：
- 起始小时 = `periodIndex * 2`
- 结束小时 = `(periodIndex * 2 + 2) % 24` （使用模运算处理跨天情况）
- 示例：索引 `0` → "00:00-02:00"，索引 `11` → "22:00-00:00"

**异常处理策略**：
- 输入值非整数或超出0-11范围时，返回 "未知时段"
- 不支持 `ConvertBack` 操作，抛出 `NotImplementedException`
- 对无效输入提供用户友好的默认显示文本

**Section sources**
- [PeriodIndexToTimeConverter.cs](file://Converters/PeriodIndexToTimeConverter.cs#L8-L26)

## 总结
本文档系统化地记录了AutoScheduling3项目中的核心数据绑定转换器。这些转换器在MVVM架构中扮演着关键角色，实现了业务数据与UI表现的解耦。通过合理使用这些转换器，开发者可以：
- 简化XAML中的条件逻辑
- 实现一致的视觉样式规范
- 提高代码的可维护性和复用性
- 减少ViewModel中的UI相关代码

所有转换器均遵循单一职责原则，每个转换器专注于一种特定的转换任务。在集成使用时，建议通过资源字典统一管理转换器实例，并在需要时进行适当的扩展和定制。