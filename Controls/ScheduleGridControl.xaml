<UserControl
    x:Class="AutoScheduling3.Controls.ScheduleGridControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:AutoScheduling3.Converters"
    xmlns:controls="using:AutoScheduling3.Controls"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!-- 转换器资源 -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:DateTimeFormatConverter x:Key="DateTimeFormatConverter"/>
        <converters:ConflictTypeToColorConverter x:Key="ConflictTypeToColorConverter"/>
        <converters:PeriodIndexToTimeConverter x:Key="PeriodIndexToTimeConverter"/>
        
        <!-- 冲突类型到文本转换器 -->
        <converters:BoolToTextConverter x:Key="ConflictTypeToTextConverter"/>
        <!-- 单元格样式 -->
        <Style x:Key="CellBorderStyle" TargetType="Border">
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="MinHeight" Value="60"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>

        <!-- 冲突单元格样式 -->
        <Style x:Key="ConflictCellBorderStyle" TargetType="Border" BasedOn="{StaticResource CellBorderStyle}">
            <Setter Property="BorderBrush" Value="{ThemeResource SystemFillColorCriticalBrush}"/>
            <Setter Property="Background" Value="{ThemeResource SystemFillColorCriticalBackgroundBrush}"/>
        </Style>

        <!-- 软约束冲突样式 -->
        <Style x:Key="SoftConflictCellBorderStyle" TargetType="Border" BasedOn="{StaticResource CellBorderStyle}">
            <Setter Property="BorderBrush" Value="{ThemeResource SystemFillColorCautionBrush}"/>
            <Setter Property="Background" Value="{ThemeResource SystemFillColorCautionBackgroundBrush}"/>
        </Style>

        <!-- 空单元格样式 -->
        <Style x:Key="EmptyCellBorderStyle" TargetType="Border" BasedOn="{StaticResource CellBorderStyle}">
            <Setter Property="Background" Value="{ThemeResource SystemFillColorNeutralBackgroundBrush}"/>
            <Setter Property="BorderStyle" Value="Dashed"/>
        </Style>

        <!-- 拖拽源样式 -->
        <Style x:Key="DragSourceCellBorderStyle" TargetType="Border" BasedOn="{StaticResource CellBorderStyle}">
            <Setter Property="BorderBrush" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Background" Value="{ThemeResource AccentFillColorSecondaryBrush}"/>
        </Style>

        <!-- 拖拽目标样式 -->
        <Style x:Key="DragTargetCellBorderStyle" TargetType="Border" BasedOn="{StaticResource CellBorderStyle}">
            <Setter Property="BorderBrush" Value="{ThemeResource AccentFillColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Background" Value="{ThemeResource AccentFillColorTertiaryBrush}"/>
        </Style>

        <!-- 单元格数据模板 -->
        <DataTemplate x:Key="CellDataTemplate" x:DataType="controls:ScheduleGridControl.CellModel">
            <Border x:Name="CellBorder" 
                    Style="{StaticResource CellBorderStyle}"
                    AllowDrop="True"
                    CanDrag="True"
                    PointerPressed="OnCellPointerPressed"
                    PointerReleased="OnCellPointerReleased"
                    PointerEntered="OnCellPointerEntered"
                    PointerExited="OnCellPointerExited"
                    RightTapped="OnCellRightTapped">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 哨位信息 -->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0"
                                   Text="{Binding Position.Name}" 
                                   FontSize="10" 
                                   FontWeight="SemiBold"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   TextTrimming="CharacterEllipsis"/>
                        
                        <!-- 夜班指示器 -->
                        <Ellipse Grid.Column="1"
                                 Width="8" 
                                 Height="8" 
                                 Fill="{ThemeResource SystemFillColorSuccessBrush}"
                                 Margin="4,0,0,0"
                                 Visibility="{Binding IsNightShift, Converter={StaticResource BoolToVisibilityConverter}}"
                                 ToolTipService.ToolTip="夜班"/>
                    </Grid>

                    <!-- 人员信息 -->
                    <StackPanel Grid.Row="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Shift.PersonnelName, FallbackValue='未分配'}" 
                                   FontSize="12" 
                                   FontWeight="SemiBold"
                                   TextWrapping="Wrap"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="2"
                                   Foreground="{Binding Shift, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter='TextColor'}"/>
                        <TextBlock Text="{x:Bind PersonnelIdText, FallbackValue='', Mode=OneWay}" 
                                   FontSize="9" 
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                   Visibility="{Binding Shift, Converter={StaticResource NullToVisibilityConverter}}"/>
                    </StackPanel>

                    <!-- 时间信息 -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="{x:Bind DateText, Mode=OneWay}" 
                                   FontSize="9" 
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                        <TextBlock Text="{Binding PeriodDisplayText}" 
                                   FontSize="9" 
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>

                    <!-- 冲突指示器 -->
                    <Border Grid.Row="3" 
                            Background="{Binding ConflictBrush}"
                            CornerRadius="2"
                            Padding="4,2"
                            Margin="0,2,0,0"
                            Visibility="{Binding HasConflict, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Text="{Binding ConflictDisplayText}" 
                                   FontSize="8" 
                                   Foreground="White"
                                   FontWeight="SemiBold"/>
                    </Border>

                    <!-- 拖拽状态覆盖层 -->
                    <Border Grid.RowSpan="4"
                            x:Name="DragOverlay"
                            Background="{ThemeResource AccentFillColorTertiaryBrush}"
                            BorderBrush="{ThemeResource AccentFillColorDefaultBrush}"
                            BorderThickness="2"
                            CornerRadius="4"
                            Opacity="0"
                            IsHitTestVisible="False"/>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- 表头数据模板 -->
        <DataTemplate x:Key="HeaderDataTemplate">
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="8,4"
                    Margin="2">
                <TextBlock Text="{Binding}" 
                           FontWeight="SemiBold"
                           FontSize="11"
                           TextAlignment="Center"
                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <Border Grid.Row="0" 
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 左侧信息 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                    <TextBlock Text="{Binding Schedule.Title, FallbackValue='排班表'}" 
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind TotalCellsText, Mode=OneWay}" 
                               FontSize="12"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind ConflictCountText, Mode=OneWay}" 
                               FontSize="12"
                               Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                               VerticalAlignment="Center"
                               Visibility="{Binding HasConflicts, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>

                <!-- 右侧控制 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <ToggleButton x:Name="ShowConflictsToggle" 
                                  Content="显示冲突" 
                                  IsChecked="{x:Bind ShowConflicts, Mode=TwoWay}"/>
                    <ToggleButton x:Name="VirtualizationToggle" 
                                  Content="虚拟化" 
                                  IsChecked="True"
                                  ToolTipService.ToolTip="启用虚拟化以提升大数据量性能"/>
                    <Button x:Name="RefreshButton" 
                            Content="刷新" 
                            Click="OnRefreshClick"
                            ToolTipService.ToolTip="刷新排班数据"/>
                    <Button x:Name="ExportButton" 
                            Content="导出" 
                            Click="OnExportClick"
                            ToolTipService.ToolTip="导出排班表数据"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 主网格区域 -->
        <ScrollViewer Grid.Row="1" 
                      x:Name="MainScrollViewer"
                      HorizontalScrollMode="Auto" 
                      VerticalScrollMode="Auto" 
                      ZoomMode="Enabled"
                      MinZoomFactor="0.5"
                      MaxZoomFactor="2.0"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      IsTabStop="False">
            
            <Grid x:Name="GridContainer">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- 左上角空白 -->
                <Border Grid.Row="0" Grid.Column="0" 
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="0,0,1,1"
                        MinWidth="100"
                        MinHeight="40"/>

                <!-- 时间轴表头 -->
                <ScrollViewer Grid.Row="0" Grid.Column="1"
                              x:Name="TimeHeaderScrollViewer"
                              HorizontalScrollMode="Disabled"
                              VerticalScrollMode="Disabled"
                              ZoomMode="Disabled"
                              HorizontalScrollBarVisibility="Hidden"
                              VerticalScrollBarVisibility="Hidden">
                    <ItemsRepeater x:Name="TimeHeaderRepeater"
                                   ItemTemplate="{StaticResource HeaderDataTemplate}">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Horizontal"/>
                        </ItemsRepeater.Layout>
                    </ItemsRepeater>
                </ScrollViewer>

                <!-- 哨位名称列 -->
                <ScrollViewer Grid.Row="1" Grid.Column="0"
                              x:Name="PositionHeaderScrollViewer"
                              HorizontalScrollMode="Disabled"
                              VerticalScrollMode="Disabled"
                              ZoomMode="Disabled"
                              HorizontalScrollBarVisibility="Hidden"
                              VerticalScrollBarVisibility="Hidden">
                    <ItemsRepeater x:Name="PositionHeaderRepeater"
                                   ItemTemplate="{StaticResource HeaderDataTemplate}">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Vertical"/>
                        </ItemsRepeater.Layout>
                    </ItemsRepeater>
                </ScrollViewer>

                <!-- 主数据网格 - 使用虚拟化 -->
                <ScrollViewer Grid.Row="1" Grid.Column="1"
                              x:Name="DataScrollViewer"
                              HorizontalScrollMode="Disabled"
                              VerticalScrollMode="Disabled"
                              ZoomMode="Disabled"
                              HorizontalScrollBarVisibility="Hidden"
                              VerticalScrollBarVisibility="Hidden">
                    <ItemsRepeater x:Name="MainGridRepeater"
                                   ItemTemplate="{StaticResource CellDataTemplate}"
                                   VerticalCacheLength="2.0"
                                   HorizontalCacheLength="2.0">
                        <ItemsRepeater.Layout>
                            <UniformGridLayout x:Name="GridLayout"
                                               Orientation="Horizontal" 
                                               MinItemWidth="120" 
                                               MinItemHeight="60"
                                               ItemsStretch="Fill"
                                               MinRowSpacing="2"
                                               MinColumnSpacing="2"/>
                        </ItemsRepeater.Layout>
                    </ItemsRepeater>
                </ScrollViewer>
            </Grid>
        </ScrollViewer>

        <!-- 加载指示器 -->
        <ProgressRing Grid.Row="1" 
                      x:Name="LoadingRing"
                      x:FieldModifier="internal"
                      IsActive="False"
                      Width="40" 
                      Height="40"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"/>

        <!-- 空状态提示 -->
        <StackPanel Grid.Row="1" 
                    x:Name="EmptyStatePanel"
                    Visibility="Collapsed"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="12">
            <FontIcon Glyph="&#xE9F3;" FontSize="48" Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
            <TextBlock Text="暂无排班数据" 
                       FontSize="16" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="请先创建排班或加载现有数据" 
                       FontSize="12" 
                       Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                       HorizontalAlignment="Center"/>
        </StackPanel>
    </Grid>
</UserControl>